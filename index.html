import React, { useState, useEffect, useRef } from 'react';
import { Play, RefreshCw, Trophy, Clock, Music, Volume2, VolumeX, Crown, Star } from 'lucide-react';

// --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---

// è‹±æ¤œãƒ¬ãƒ™ãƒ«ã®å®šç¾©
type WordLevel = 1 | 2 | 3; // 1: Bronze(10), 2: Silver(20), 3: Gold(30)

interface WordCard {
  en: string;
  ja: string;
  level: WordLevel;
}

interface TopicData {
  emoji: string;
  title: string;
  hint: string;
  words: WordCard[];
}

// æ—¥å¸¸çš„ãªãƒˆãƒ”ãƒƒã‚¯ã¨ãƒ¬ãƒ™ãƒ«åˆ¥å˜èªãƒªã‚¹ãƒˆ
// è‹±æ¤œ4ç´šä»¥ä¸‹(L1), 3ç´š(L2), æº–2ç´š(L3)ã‚’ç›®å®‰ã«åˆ†é¡
const TOPICS_DATA: TopicData[] = [
  { 
    emoji: "ğŸ«",
    title: "School Life", 
    hint: "What do you like about school?",
    words: [
      // Level 1 (+10)
      { en: "teacher", ja: "å…ˆç”Ÿ", level: 1 },
      { en: "class", ja: "æˆæ¥­", level: 1 },
      { en: "friend", ja: "å‹é”", level: 1 },
      { en: "lunch", ja: "æ˜¼é£Ÿ", level: 1 },
      // Level 2 (+20)
      { en: "subject", ja: "ç§‘ç›®", level: 2 },
      { en: "uniform", ja: "åˆ¶æœ", level: 2 },
      { en: "graduate", ja: "å’æ¥­ã™ã‚‹", level: 2 },
      { en: "event", ja: "è¡Œäº‹", level: 2 },
      // Level 3 (+30)
      { en: "atmosphere", ja: "é›°å›²æ°—", level: 3 },
      { en: "concentrate", ja: "é›†ä¸­ã™ã‚‹", level: 3 },
      { en: "encourage", ja: "åŠ±ã¾ã™", level: 3 },
      { en: "opportunity", ja: "æ©Ÿä¼š", level: 3 },
    ]
  },
  { 
    emoji: "ğŸ”",
    title: "Food", 
    hint: "What is your favorite food?",
    words: [
      { en: "delicious", ja: "ãŠã„ã—ã„", level: 1 },
      { en: "cook", ja: "æ–™ç†ã™ã‚‹", level: 1 },
      { en: "sweet", ja: "ç”˜ã„", level: 1 },
      { en: "eat", ja: "é£Ÿã¹ã‚‹", level: 1 },
      { en: "healthy", ja: "å¥åº·çš„ãª", level: 2 },
      { en: "recipe", ja: "ãƒ¬ã‚·ãƒ”", level: 2 },
      { en: "traditional", ja: "ä¼çµ±çš„ãª", level: 2 },
      { en: "taste", ja: "å‘³", level: 2 },
      { en: "ingredient", ja: "ææ–™", level: 3 },
      { en: "nutrition", ja: "æ „é¤Š", level: 3 },
      { en: "recommend", ja: "å‹§ã‚ã‚‹", level: 3 },
      { en: "contain", ja: "å«ã‚€", level: 3 },
    ]
  },
  { 
    emoji: "âœˆï¸",
    title: "Travel", 
    hint: "Where do you want to go?",
    words: [
      { en: "trip", ja: "æ—…è¡Œ", level: 1 },
      { en: "country", ja: "å›½", level: 1 },
      { en: "sea", ja: "æµ·", level: 1 },
      { en: "hotel", ja: "ãƒ›ãƒ†ãƒ«", level: 1 },
      { en: "foreign", ja: "å¤–å›½ã®", level: 2 },
      { en: "experience", ja: "çµŒé¨“", level: 2 },
      { en: "culture", ja: "æ–‡åŒ–", level: 2 },
      { en: "tourist", ja: "è¦³å…‰å®¢", level: 2 },
      { en: "environment", ja: "ç’°å¢ƒ", level: 3 },
      { en: "scenery", ja: "é¢¨æ™¯", level: 3 },
      { en: "communicate", ja: "æ„æ€ç–é€šã™ã‚‹", level: 3 },
      { en: "destination", ja: "ç›®çš„åœ°", level: 3 },
    ]
  },
  { 
    emoji: "ğŸ®",
    title: "Hobbies", 
    hint: "What do you do in your free time?",
    words: [
      { en: "like", ja: "å¥½ã", level: 1 },
      { en: "play", ja: "éŠã¶", level: 1 },
      { en: "watch", ja: "è¦‹ã‚‹", level: 1 },
      { en: "game", ja: "ã‚²ãƒ¼ãƒ ", level: 1 },
      { en: "exciting", ja: "ã‚ãã‚ãã™ã‚‹", level: 2 },
      { en: "movie", ja: "æ˜ ç”»", level: 2 },
      { en: "relax", ja: "ãƒªãƒ©ãƒƒã‚¯ã‚¹ã™ã‚‹", level: 2 },
      { en: "practice", ja: "ç·´ç¿’ã™ã‚‹", level: 2 },
      { en: "instrument", ja: "æ¥½å™¨", level: 3 },
      { en: "creative", ja: "å‰µé€ çš„ãª", level: 3 },
      { en: "satisfied", ja: "æº€è¶³ã—ãŸ", level: 3 },
      { en: "improve", ja: "å‘ä¸Šã•ã›ã‚‹", level: 3 },
    ]
  },
  { 
    emoji: "ğŸ”®",
    title: "Future", 
    hint: "What do you want to be?",
    words: [
      { en: "job", ja: "ä»•äº‹", level: 1 },
      { en: "money", ja: "ãŠé‡‘", level: 1 },
      { en: "dream", ja: "å¤¢", level: 1 },
      { en: "big", ja: "å¤§ãã„", level: 1 },
      { en: "decide", ja: "æ±ºã‚ã‚‹", level: 2 },
      { en: "abroad", ja: "æµ·å¤–ã§", level: 2 },
      { en: "company", ja: "ä¼šç¤¾", level: 2 },
      { en: "useful", ja: "å½¹ã«ç«‹ã¤", level: 2 },
      { en: "society", ja: "ç¤¾ä¼š", level: 3 },
      { en: "contribute", ja: "è²¢çŒ®ã™ã‚‹", level: 3 },
      { en: "specialist", ja: "å°‚é–€å®¶", level: 3 },
      { en: "realize", ja: "å®Ÿç¾ã™ã‚‹", level: 3 },
    ]
  }
];

// ä¿¡é ¼æ€§ã®é«˜ã„BGM URL
const BGM_SOURCES = [
  "https://cdn.pixabay.com/download/audio/2022/11/22/audio_febc508520.mp3", // Happy Upbeat
  "https://cdn.pixabay.com/download/audio/2022/10/25/audio_5103407886.mp3", // Fun Comedy
];

// ãƒã‚¤ãƒ³ãƒˆå®šç¾©
const POINTS = {
  1: 10,
  2: 20,
  3: 30
};

export default function App() {
  // --- State Management ---
  const [mode, setMode] = useState<'menu' | 'game'>('menu');
  
  // Game Data
  const [currentTopic, setCurrentTopic] = useState(TOPICS_DATA[0]);
  const [activeCards, setActiveCards] = useState<WordCard[]>([]);
  
  // Game Status
  const [timeLeft, setTimeLeft] = useState(60);
  const [gameTime, setGameTime] = useState(60);
  const [isActive, setIsActive] = useState(false);
  
  // Scoring: Player A vs Player B
  const [scoreA, setScoreA] = useState(0);
  const [scoreB, setScoreB] = useState(0);
  
  // Card Ownership: { index: 'A' | 'B' | null }
  const [cardStatus, setCardStatus] = useState<Record<number, 'A' | 'B' | null>>({});

  // Audio
  const [isMuted, setIsMuted] = useState(false);
  const audioRef = useRef<HTMLAudioElement | null>(null);

  const timerRef = useRef<NodeJS.Timeout | null>(null);

  // --- Logic ---

  // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–ï¼ˆãƒˆãƒ”ãƒƒã‚¯å¤‰æ›´æ™‚ã‚‚å‘¼ã¶ï¼‰
  const initRound = () => {
    // ãƒ©ãƒ³ãƒ€ãƒ ãƒˆãƒ”ãƒƒã‚¯
    const randomTopic = TOPICS_DATA[Math.floor(Math.random() * TOPICS_DATA.length)];
    setCurrentTopic(randomTopic);

    // ã‚«ãƒ¼ãƒ‰é¸å‡ºãƒ­ã‚¸ãƒƒã‚¯: å„ãƒ¬ãƒ™ãƒ«ã‹ã‚‰ãƒãƒ©ãƒ³ã‚¹ã‚ˆãé¸å‡º
    // Level 1: 2æš, Level 2: 2æš, Level 3: 2æš -> è¨ˆ6æš
    const l1 = (randomTopic.words || []).filter(w => w.level === 1).sort(() => 0.5 - Math.random()).slice(0, 2);
    const l2 = (randomTopic.words || []).filter(w => w.level === 2).sort(() => 0.5 - Math.random()).slice(0, 2);
    const l3 = (randomTopic.words || []).filter(w => w.level === 3).sort(() => 0.5 - Math.random()).slice(0, 2);
    
    // æ··ãœã‚‹
    const mixed = [...l1, ...l2, ...l3].sort(() => 0.5 - Math.random());
    setActiveCards(mixed);

    // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
    setCardStatus({});
    setScoreA(0);
    setScoreB(0);
    setTimeLeft(gameTime);
    setIsActive(false);
    
    // éŸ³æ¥½åœæ­¢
    if (audioRef.current) {
      audioRef.current.pause();
      audioRef.current.currentTime = 0;
    }
  };

  const startGame = () => {
    setIsActive(true);
    
    // BGMå†ç”Ÿãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£
    if (!isMuted && audioRef.current) {
      const randomSrc = BGM_SOURCES[Math.floor(Math.random() * BGM_SOURCES.length)];
      audioRef.current.src = randomSrc;
      audioRef.current.volume = 0.3; // éŸ³é‡ã‚’å°‘ã—ä¸‹ã’ã‚‹
      
      const playPromise = audioRef.current.play();
      if (playPromise !== undefined) {
        playPromise.catch(error => {
          console.log("Audio playback was prevented or interrupted:", error);
        });
      }
    }
  };

  // ã‚¿ã‚¤ãƒãƒ¼
  useEffect(() => {
    if (isActive && timeLeft > 0) {
      timerRef.current = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
    } else if (timeLeft === 0) {
      setIsActive(false);
      if (audioRef.current) {
        audioRef.current.pause();
        audioRef.current.currentTime = 0;
      }
    }
    return () => {
      if (timerRef.current) clearTimeout(timerRef.current);
    };
  }, [isActive, timeLeft]);

  // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
  const handleCardClick = (index: number, player: 'A' | 'B') => {
    if (!isActive && timeLeft > 0) return; // ã‚²ãƒ¼ãƒ ä¸­ã®ã¿
    if (cardStatus[index]) return; // å–å¾—æ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„

    // å–å¾—çŠ¶æ…‹æ›´æ–°
    setCardStatus(prev => ({ ...prev, [index]: player }));

    // ç‚¹æ•°åŠ ç®—
    const card = activeCards[index];
    if (card) {
      const points = POINTS[card.level];
      if (player === 'A') setScoreA(s => s + points);
      else setScoreB(s => s + points);
    }
  };

  // --- Components ---

  const WinnerOverlay = () => {
    if (timeLeft > 0) return null;
    
    let resultTitle = "";
    let resultColor = "";
    if (scoreA > scoreB) {
      resultTitle = "WINNER: PLAYER A";
      resultColor = "text-blue-600";
    } else if (scoreB > scoreA) {
      resultTitle = "WINNER: PLAYER B";
      resultColor = "text-pink-600";
    } else {
      resultTitle = "DRAW!";
      resultColor = "text-purple-600";
    }

    return (
      <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center animate-in fade-in duration-500 backdrop-blur-sm">
        <div className="bg-white p-8 md:p-12 rounded-3xl shadow-2xl text-center transform animate-in zoom-in duration-300 max-w-2xl w-full mx-4 border-4 border-yellow-400">
          <Crown size={80} className={`mx-auto mb-4 ${resultColor} animate-bounce`} />
          <h2 className={`text-4xl md:text-5xl font-black ${resultColor} mb-6`}>{resultTitle}</h2>
          
          <div className="flex justify-center gap-8 md:gap-16 mb-8">
            <div className="bg-blue-50 p-4 rounded-xl w-32">
              <div className="text-sm font-bold text-blue-400">Player A</div>
              <div className="text-4xl font-black text-blue-600">{scoreA}</div>
            </div>
            <div className="bg-pink-50 p-4 rounded-xl w-32">
              <div className="text-sm font-bold text-pink-400">Player B</div>
              <div className="text-4xl font-black text-pink-600">{scoreB}</div>
            </div>
          </div>

          <button 
            onClick={initRound} 
            className="w-full py-4 bg-slate-800 text-white rounded-xl font-bold text-xl hover:bg-slate-700 hover:scale-[1.02] transition-all shadow-lg flex items-center justify-center gap-2"
          >
            <RefreshCw /> Play Again
          </button>
        </div>
      </div>
    );
  };

  const GameScreen = () => {
    const progress = (timeLeft / gameTime) * 100;

    return (
      <div className="flex flex-col h-screen bg-slate-100 text-slate-800 overflow-hidden font-sans">
        
        {/* Top Bar */}
        <div className="bg-white shadow-sm border-b px-4 py-2 flex justify-between items-center shrink-0 h-16">
          <button onClick={() => setMode('menu')} className="text-slate-400 font-bold text-xs hover:text-slate-600 px-2 py-1 rounded border border-transparent hover:border-slate-200">
            EXIT
          </button>
          
          {/* Score Display */}
          <div className="flex items-center gap-4 md:gap-12 flex-1 justify-center">
            {/* Player A */}
            <div className={`flex flex-col items-center transition-transform ${scoreA > scoreB ? 'scale-110' : 'scale-100'}`}>
              <span className="text-[10px] font-black text-blue-500 tracking-widest">PLAYER A</span>
              <span className="text-3xl font-black text-blue-600 leading-none">{scoreA}</span>
            </div>
            
            {/* Timer */}
            <div className={`flex flex-col items-center w-20 ${timeLeft < 10 ? 'text-red-500 animate-pulse' : 'text-slate-700'}`}>
              <Clock size={18} className="mb-0.5 opacity-50" />
              <span className="text-2xl font-mono font-bold leading-none">{timeLeft}</span>
            </div>

            {/* Player B */}
            <div className={`flex flex-col items-center transition-transform ${scoreB > scoreA ? 'scale-110' : 'scale-100'}`}>
              <span className="text-[10px] font-black text-pink-500 tracking-widest">PLAYER B</span>
              <span className="text-3xl font-black text-pink-600 leading-none">{scoreB}</span>
            </div>
          </div>

          <button onClick={() => setIsMuted(!isMuted)} className="text-slate-400 hover:text-slate-600 p-2">
            {isMuted ? <VolumeX size={20} /> : <Volume2 size={20} />}
          </button>
        </div>

        {/* Progress Bar */}
        <div className="w-full bg-slate-200 h-2 shrink-0">
          <div 
            className={`h-full transition-all duration-1000 linear ${timeLeft < 10 ? 'bg-red-500' : 'bg-gradient-to-r from-blue-400 to-pink-400'}`} 
            style={{ width: `${progress}%` }}
          ></div>
        </div>

        {/* Main Game Area */}
        <div className="flex-1 flex flex-col p-2 md:p-4 gap-4 overflow-hidden max-w-6xl mx-auto w-full">
          
          {/* Topic Header */}
          <div 
            onClick={initRound}
            className="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 flex flex-col items-center justify-center text-center shrink-0 relative cursor-pointer hover:shadow-md transition-all group"
          >
            <div className="absolute top-3 right-3 text-slate-300 group-hover:text-indigo-500 transition-colors">
              <RefreshCw size={18}/>
            </div>
            <div className="flex items-center gap-3 mb-1">
              <span className="text-4xl">{currentTopic.emoji}</span>
              <h2 className="text-xl md:text-2xl font-black text-slate-800 uppercase tracking-tight">{currentTopic.title}</h2>
            </div>
            <p className="text-slate-500 font-medium text-sm md:text-lg">"{currentTopic.hint}"</p>
          </div>

          {/* Cards Grid */}
          <div className="flex-1 relative">
            {/* Start Button Overlay */}
            {!isActive && timeLeft === gameTime && (
              <div className="absolute inset-0 z-20 flex items-center justify-center bg-white/50 backdrop-blur-[2px] rounded-xl">
                 <button 
                   onClick={startGame} 
                   className="group relative bg-slate-900 text-white px-10 py-6 rounded-full font-black text-3xl shadow-2xl hover:scale-105 transition-transform flex items-center gap-4 overflow-hidden"
                 >
                   <div className="absolute inset-0 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                   <span className="relative flex items-center gap-3 z-10"><Play fill="currentColor" /> START</span>
                 </button>
              </div>
            )}

            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 h-full content-start">
              {activeCards.map((card, idx) => {
                const status = cardStatus[idx]; // 'A' or 'B' or null
                const isUsed = !!status;
                const points = POINTS[card.level];
                
                // è‰²åˆ†ã‘: Bronze(Level1), Silver(Level2), Gold(Level3)
                let borderClass = "";
                let bgClass = "";
                let badgeColor = "";
                let levelLabel = "";

                if (card.level === 1) {
                  borderClass = "border-blue-200";
                  bgClass = "bg-blue-50/30";
                  badgeColor = "bg-blue-500";
                  levelLabel = "L1 (+10)";
                } else if (card.level === 2) {
                  borderClass = "border-emerald-200";
                  bgClass = "bg-emerald-50/30";
                  badgeColor = "bg-emerald-500";
                  levelLabel = "L2 (+20)";
                } else {
                  borderClass = "border-yellow-200";
                  bgClass = "bg-yellow-50/30";
                  badgeColor = "bg-yellow-500";
                  levelLabel = "L3 (+30)";
                }

                return (
                  <div 
                    key={idx}
                    className={`
                      relative rounded-xl border-2 shadow-sm overflow-hidden flex flex-col justify-between transition-all select-none
                      aspect-[3/4] md:aspect-auto md:h-full
                      ${borderClass} ${bgClass}
                      ${isUsed ? 'opacity-50 grayscale scale-95' : 'hover:-translate-y-1 hover:shadow-md'}
                    `}
                  >
                    {/* Level Badge */}
                    <div className="flex justify-between items-center px-2 py-1.5 border-b border-black/5 bg-white/50">
                      <span className={`text-[10px] font-bold text-white px-2 py-0.5 rounded-full ${badgeColor}`}>
                        {levelLabel}
                      </span>
                    </div>

                    {/* Content */}
                    <div className="flex-1 flex flex-col items-center justify-center p-2 text-center">
                      <div className="font-bold text-lg leading-tight mb-1 text-slate-800">{card.en}</div>
                      <div className="text-xs text-slate-500">{card.ja}</div>
                    </div>

                    {/* Click Areas (Invisible until hover/touch) */}
                    {!isUsed ? (
                      <div className="absolute inset-0 z-10 flex opacity-0 hover:opacity-100 active:opacity-100 transition-opacity cursor-pointer">
                        {/* Player A Area */}
                        <div 
                          className="w-1/2 h-full bg-blue-500/10 flex items-center justify-center border-r border-slate-300/30 active:bg-blue-500/30 transition-colors"
                          onClick={() => handleCardClick(idx, 'A')}
                        >
                          <span className="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded shadow-sm transform -translate-x-2">A</span>
                        </div>
                        {/* Player B Area */}
                        <div 
                          className="w-1/2 h-full bg-pink-500/10 flex items-center justify-center active:bg-pink-500/30 transition-colors"
                          onClick={() => handleCardClick(idx, 'B')}
                        >
                           <span className="bg-pink-600 text-white text-xs font-bold px-2 py-1 rounded shadow-sm transform translate-x-2">B</span>
                        </div>
                      </div>
                    ) : (
                      // Taken Overlay
                      <div className="absolute inset-0 flex items-center justify-center bg-slate-100/80 z-20 backdrop-blur-[1px]">
                         <div className={`text-4xl font-black ${status === 'A' ? 'text-blue-500' : 'text-pink-500'}`}>
                           {status}
                         </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        </div>
        
        <WinnerOverlay />
      </div>
    );
  };

  const MenuScreen = () => (
    <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50 p-6 font-sans text-slate-800">
      <div className="bg-white p-10 rounded-3xl shadow-xl w-full max-w-md text-center border border-slate-200">
        <div className="mb-6 flex justify-center">
          <div className="bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-4 rounded-2xl shadow-lg">
            <Trophy size={48} />
          </div>
        </div>
        <h1 className="text-4xl font-black mb-2 text-slate-900 tracking-tight">
          PAIR SPEAKING<br/>CHALLENGE
        </h1>
        <p className="text-slate-500 mb-8 font-medium">Earn points by using English!</p>

        <div className="space-y-4 mb-8 text-left bg-slate-50 p-4 rounded-xl border border-slate-100">
          <h3 className="font-bold text-slate-700 flex items-center gap-2">
            <Star size={16} className="text-yellow-500" fill="currentColor"/> Points System
          </h3>
          <ul className="text-sm space-y-2 text-slate-600">
            <li className="flex justify-between items-center">
              <span><span className="bg-blue-500 text-white px-1.5 rounded-full text-[10px] mr-2 font-bold">L1</span>Basic Words</span>
              <span className="font-bold text-blue-600">+10 pt</span>
            </li>
            <li className="flex justify-between items-center">
              <span><span className="bg-emerald-500 text-white px-1.5 rounded-full text-[10px] mr-2 font-bold">L2</span>Grade 3</span>
              <span className="font-bold text-emerald-600">+20 pt</span>
            </li>
            <li className="flex justify-between items-center">
              <span><span className="bg-yellow-500 text-white px-1.5 rounded-full text-[10px] mr-2 font-bold">L3</span>Grade Pre-2</span>
              <span className="font-bold text-yellow-600">+30 pt</span>
            </li>
          </ul>
        </div>

        <button
          onClick={initRound}
          onClickCapture={() => setMode('game')}
          className="w-full bg-slate-900 text-white py-5 rounded-2xl text-xl font-bold shadow-xl hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-3"
        >
          <Play fill="currentColor" /> START GAME
        </button>
      </div>
    </div>
  );

  return (
    <>
      <audio ref={audioRef} loop />
      {mode === 'menu' && <MenuScreen />}
      {mode === 'game' && <GameScreen />}
    </>
  );
}
