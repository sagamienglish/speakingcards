<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pair Speaking Challenge</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel (JSXÂ§âÊèõÁî®) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      touch-action: manipulation; /* „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„Ç∫„Éº„É†Èò≤Ê≠¢ */
      user-select: none; /* „ÉÜ„Ç≠„Çπ„ÉàÈÅ∏ÊäûÈò≤Ê≠¢ */
    }
    
    /* „Çπ„Ç≥„Ç¢Âä†ÁÇπÊôÇ„ÅÆ„Éù„ÉÉ„Éó„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.5); color: #fbbf24; }
      100% { transform: scale(1); }
    }
    .score-pop {
      animation: pop 0.3s ease-out;
    }

    /* „Éà„Éî„ÉÉ„ÇØÂàá„ÇäÊõø„ÅàÊôÇ„ÅÆ„Çπ„É©„Ç§„Éâ„Ç§„É≥„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
    @keyframes slideInRight {
      from { transform: translateX(50px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .topic-enter {
      animation: slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* „Éú„Çø„É≥„ÅÆÊ≥®ÁõÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
    @keyframes bounce-subtle {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }
    .btn-bounce {
      animation: bounce-subtle 2s infinite ease-in-out;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- „Ç¢„Ç§„Ç≥„É≥„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà ---
    const IconWrapper = ({ children, size = 24, className = "" }) => (
      <svg 
        xmlns="http://www.w3.org/2000/svg" 
        width={size} 
        height={size} 
        viewBox="0 0 24 24" 
        fill="none" 
        stroke="currentColor" 
        strokeWidth="2" 
        strokeLinecap="round" 
        strokeLinejoin="round" 
        className={className}
      >
        {children}
      </svg>
    );

    const Play = (props) => (
      <IconWrapper {...props}>
        <polygon points="5 3 19 12 5 21 5 3"></polygon>
      </IconWrapper>
    );

    const RefreshCw = (props) => (
      <IconWrapper {...props}>
        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
        <path d="M21 3v5h-5"></path>
        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
        <path d="M8 16H3v5"></path>
      </IconWrapper>
    );

    const Trophy = (props) => (
      <IconWrapper {...props}>
        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
        <path d="M4 22h16"></path>
        <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
        <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
        <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
      </IconWrapper>
    );

    const Clock = (props) => (
      <IconWrapper {...props}>
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </IconWrapper>
    );

    const Volume2 = (props) => (
      <IconWrapper {...props}>
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
      </IconWrapper>
    );

    const VolumeX = (props) => (
      <IconWrapper {...props}>
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
        <line x1="23" y1="9" x2="17" y2="15"></line>
        <line x1="17" y1="9" x2="23" y2="15"></line>
      </IconWrapper>
    );

    const Crown = (props) => (
      <IconWrapper {...props}>
        <path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"></path>
      </IconWrapper>
    );

    const Star = (props) => (
      <IconWrapper {...props}>
        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
      </IconWrapper>
    );

    const SkipForward = (props) => (
      <IconWrapper {...props}>
        <polygon points="5 4 15 12 5 20 5 4"></polygon>
        <line x1="19" y1="5" x2="19" y2="19"></line>
      </IconWrapper>
    );

    // --- „Éá„Éº„ÇøÂÆöÁæ© ---

    const TOPICS_DATA = [
      { 
        emoji: "üå∏", title: "Season", hint: "Which season do you like the best?",
        words: [
          { en: "spring", ja: "Êò•", level: 1 }, { en: "summer", ja: "Â§è", level: 1 },
          { en: "winter", ja: "ÂÜ¨", level: 1 }, { en: "hot", ja: "Êöë„ÅÑ", level: 1 },
          { en: "cold", ja: "ÂØí„ÅÑ", level: 1 }, { en: "rain", ja: "Èõ®", level: 1 },
          { en: "season", ja: "Â≠£ÁØÄ", level: 2 }, { en: "weather", ja: "Â§©Ê∞ó", level: 2 },
          { en: "fall", ja: "Áßã", level: 2 }, { en: "warm", ja: "Êöñ„Åã„ÅÑ", level: 2 },
          { en: "cool", ja: "Ê∂º„Åó„ÅÑ", level: 2 }, { en: "snow", ja: "Èõ™", level: 2 },
          { en: "temperature", ja: "Ê∞óÊ∏©", level: 3 }, { en: "comfortable", ja: "Âø´ÈÅ©„Å™", level: 3 },
          { en: "climate", ja: "Ê∞óÂÄô", level: 3 }, { en: "humid", ja: "ÊπøÊ∞ó„ÅÆÂ§ö„ÅÑ", level: 3 },
          { en: "scenery", ja: "È¢®ÊôØ", level: 3 }
        ]
      },
      { 
        emoji: "üçî", title: "Food", hint: "What is your favorite food?",
        words: [
          { en: "delicious", ja: "„Åä„ÅÑ„Åó„ÅÑ", level: 1 }, { en: "sweet", ja: "Áîò„ÅÑ", level: 1 },
          { en: "eat", ja: "È£ü„Åπ„Çã", level: 1 }, { en: "cook", ja: "ÊñôÁêÜ„Åô„Çã", level: 1 },
          { en: "meat", ja: "ËÇâ", level: 1 }, { en: "vegetable", ja: "ÈáéËèú", level: 1 },
          { en: "fruit", ja: "ÊûúÁâ©", level: 1 }, { en: "spicy", ja: "Ëæõ„ÅÑ", level: 2 },
          { en: "healthy", ja: "ÂÅ•Â∫∑ÁöÑ„Å™", level: 2 }, { en: "traditional", ja: "‰ºùÁµ±ÁöÑ„Å™", level: 2 },
          { en: "taste", ja: "Âë≥", level: 2 }, { en: "restaurant", ja: "„É¨„Çπ„Éà„É©„É≥", level: 2 },
          { en: "ingredient", ja: "ÊùêÊñô", level: 3 }, { en: "nutrition", ja: "Ê†ÑÈ§ä", level: 3 },
          { en: "recommend", ja: "Âãß„ÇÅ„Çã", level: 3 }, { en: "flavor", ja: "È¢®Âë≥", level: 3 }
        ]
      },
      { 
        emoji: "üçû", title: "Breakfast", hint: "What do you eat for breakfast?",
        words: [
          { en: "bread", ja: "„Éë„É≥", level: 1 }, { en: "rice", ja: "Á±≥", level: 1 },
          { en: "egg", ja: "Âçµ", level: 1 }, { en: "milk", ja: "Áâõ‰π≥", level: 1 },
          { en: "fruit", ja: "ÊûúÁâ©", level: 1 }, { en: "morning", ja: "Êúù", level: 1 },
          { en: "toast", ja: "„Éà„Éº„Çπ„Éà", level: 2 }, { en: "soup", ja: "„Çπ„Éº„Éó", level: 2 },
          { en: "coffee", ja: "„Ç≥„Éº„Éí„Éº", level: 2 }, { en: "juice", ja: "„Ç∏„É•„Éº„Çπ", level: 2 },
          { en: "yogurt", ja: "„É®„Éº„Ç∞„É´„Éà", level: 2 }, { en: "busy", ja: "Âøô„Åó„ÅÑ", level: 2 },
          { en: "energy", ja: "„Ç®„Éç„É´„ÇÆ„Éº", level: 3 }, { en: "habit", ja: "ÁøíÊÖ£", level: 3 },
          { en: "prepare", ja: "Ê∫ñÂÇô„Åô„Çã", level: 3 }, { en: "healthy", ja: "ÂÅ•Â∫∑ÁöÑ„Å™", level: 3 }
        ]
      },
      { 
        emoji: "üéµ", title: "Music", hint: "What kind of music do you like?",
        words: [
          { en: "sing", ja: "Ê≠å„ÅÜ", level: 1 }, { en: "listen", ja: "ËÅû„Åè", level: 1 },
          { en: "song", ja: "Ê≠å", level: 1 }, { en: "band", ja: "„Éê„É≥„Éâ", level: 1 },
          { en: "cool", ja: "„Åã„Å£„Åì„ÅÑ„ÅÑ", level: 1 }, { en: "pop", ja: "„Éù„ÉÉ„Éó", level: 1 },
          { en: "rock", ja: "„É≠„ÉÉ„ÇØ", level: 2 }, { en: "concert", ja: "„Ç≥„É≥„Çµ„Éº„Éà", level: 2 },
          { en: "voice", ja: "Â£∞", level: 2 }, { en: "artist", ja: "„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà", level: 2 },
          { en: "piano", ja: "„Éî„Ç¢„Éé", level: 2 }, { en: "relax", ja: "„É™„É©„ÉÉ„ÇØ„Çπ„Åô„Çã", level: 2 },
          { en: "lyrics", ja: "Ê≠åË©û", level: 3 }, { en: "rhythm", ja: "„É™„Ç∫„É†", level: 3 },
          { en: "melody", ja: "ÊóãÂæã", level: 3 }, { en: "performance", ja: "ÊºîÂ•è", level: 3 }
        ]
      },
      { 
        emoji: "üéÆ", title: "Hobby", hint: "What do you do in your free time?",
        words: [
          { en: "like", ja: "Â•Ω„Åç", level: 1 }, { en: "play", ja: "ÈÅä„Å∂", level: 1 },
          { en: "game", ja: "„Ç≤„Éº„É†", level: 1 }, { en: "read", ja: "Ë™≠„ÇÄ", level: 1 },
          { en: "watch", ja: "Ë¶ã„Çã", level: 1 }, { en: "make", ja: "‰Ωú„Çã", level: 1 },
          { en: "movie", ja: "Êò†Áîª", level: 2 }, { en: "music", ja: "Èü≥Ê•Ω", level: 2 },
          { en: "sports", ja: "„Çπ„Éù„Éº„ÉÑ", level: 2 }, { en: "collect", ja: "ÈõÜ„ÇÅ„Çã", level: 2 },
          { en: "draw", ja: "Êèè„Åè", level: 2 }, { en: "practice", ja: "Á∑¥Áøí„Åô„Çã", level: 2 },
          { en: "creative", ja: "ÂâµÈÄ†ÁöÑ„Å™", level: 3 }, { en: "relax", ja: "„É™„É©„ÉÉ„ÇØ„Çπ„Åô„Çã", level: 3 },
          { en: "enjoy", ja: "Ê•Ω„Åó„ÇÄ", level: 3 }, { en: "skill", ja: "ÊäÄË°ì", level: 3 }
        ]
      },
      { 
        emoji: "‚è∞", title: "Morning", hint: "What time do you get up?",
        words: [
          { en: "time", ja: "ÊôÇÈñì", level: 1 }, { en: "get up", ja: "Ëµ∑„Åç„Çã", level: 1 },
          { en: "sleep", ja: "ÂØù„Çã", level: 1 }, { en: "eat", ja: "È£ü„Åπ„Çã", level: 1 },
          { en: "wash", ja: "Ê¥ó„ÅÜ", level: 1 }, { en: "face", ja: "È°î", level: 1 },
          { en: "early", ja: "Êó©„ÅÑ", level: 2 }, { en: "late", ja: "ÈÅÖ„ÅÑ", level: 2 },
          { en: "breakfast", ja: "ÊúùÈ£ü", level: 2 }, { en: "uniform", ja: "Âà∂Êúç", level: 2 },
          { en: "clock", ja: "ÊôÇË®à", level: 2 }, { en: "busy", ja: "Âøô„Åó„ÅÑ", level: 2 },
          { en: "alarm", ja: "ÁõÆË¶ö„Åæ„Åó", level: 3 }, { en: "routine", ja: "Êó•Ë™≤", level: 3 },
          { en: "hurry", ja: "ÊÄ•„Åê", level: 3 }, { en: "prepare", ja: "Ê∫ñÂÇô„Åô„Çã", level: 3 }
        ]
      },
      { 
        emoji: "üë´", title: "Friends", hint: "Talk about your friends.",
        words: [
          { en: "friend", ja: "ÂèãÈÅî", level: 1 }, { en: "play", ja: "ÈÅä„Å∂", level: 1 },
          { en: "kind", ja: "Ë¶™Âàá„Å™", level: 1 }, { en: "talk", ja: "Ë©±„Åô", level: 1 },
          { en: "help", ja: "Êâã‰ºù„ÅÜ", level: 1 }, { en: "school", ja: "Â≠¶Ê†°", level: 1 },
          { en: "together", ja: "‰∏ÄÁ∑í„Å´", level: 2 }, { en: "funny", ja: "Èù¢ÁôΩ„ÅÑ", level: 2 },
          { en: "classmate", ja: "Á¥öÂèã", level: 2 }, { en: "trust", ja: "‰ø°È†º„Åô„Çã", level: 2 },
          { en: "same", ja: "Âêå„Åò", level: 2 }, { en: "group", ja: "„Ç∞„É´„Éº„Éó", level: 2 },
          { en: "relationship", ja: "Èñ¢‰øÇ", level: 3 }, { en: "support", ja: "ÊîØ„Åà„Çã", level: 3 },
          { en: "memory", ja: "ÊÄù„ÅÑÂá∫", level: 3 }, { en: "advice", ja: "Âä©Ë®Ä", level: 3 }
        ]
      },
      { 
        emoji: "‚úàÔ∏è", title: "Travel", hint: "Where do you want to go?",
        words: [
          { en: "go", ja: "Ë°å„Åè", level: 1 }, { en: "want", ja: "Ê¨≤„Åó„ÅÑ", level: 1 },
          { en: "trip", ja: "ÊóÖË°å", level: 1 }, { en: "country", ja: "ÂõΩ", level: 1 },
          { en: "sea", ja: "Êµ∑", level: 1 }, { en: "food", ja: "È£ü„ÅπÁâ©", level: 1 },
          { en: "plane", ja: "È£õË°åÊ©ü", level: 2 }, { en: "hotel", ja: "„Éõ„ÉÜ„É´", level: 2 },
          { en: "foreign", ja: "Â§ñÂõΩ„ÅÆ", level: 2 }, { en: "culture", ja: "ÊñáÂåñ", level: 2 },
          { en: "souvenir", ja: "„ÅäÂúüÁî£", level: 2 }, { en: "beautiful", ja: "Áæé„Åó„ÅÑ", level: 2 },
          { en: "sightseeing", ja: "Ë¶≥ÂÖâ", level: 3 }, { en: "experience", ja: "ÁµåÈ®ì", level: 3 },
          { en: "abroad", ja: "Êµ∑Â§ñ„Å∏", level: 3 }, { en: "destination", ja: "ÁõÆÁöÑÂú∞", level: 3 }
        ]
      },
      { 
        emoji: "üéí", title: "Subject", hint: "What is your favorite subject?",
        words: [
          { en: "class", ja: "ÊéàÊ•≠", level: 1 }, { en: "teacher", ja: "ÂÖàÁîü", level: 1 },
          { en: "math", ja: "Êï∞Â≠¶", level: 1 }, { en: "English", ja: "Ëã±Ë™û", level: 1 },
          { en: "music", ja: "Èü≥Ê•Ω", level: 1 }, { en: "art", ja: "ÁæéË°ì", level: 1 },
          { en: "study", ja: "ÂãâÂº∑„Åô„Çã", level: 2 }, { en: "history", ja: "Ê≠¥Âè≤", level: 2 },
          { en: "science", ja: "ÁêÜÁßë", level: 2 }, { en: "easy", ja: "Á∞°Âçò„Å™", level: 2 },
          { en: "PE", ja: "‰ΩìËÇ≤", level: 2 }, { en: "test", ja: "„ÉÜ„Çπ„Éà", level: 2 },
          { en: "interesting", ja: "ËààÂë≥Ê∑±„ÅÑ", level: 3 }, { en: "useful", ja: "ÂΩπ„Å´Á´ã„Å§", level: 3 },
          { en: "knowledge", ja: "Áü•Ë≠ò", level: 3 }, { en: "grade", ja: "ÊàêÁ∏æ", level: 3 }
        ]
      },
      { 
        emoji: "‚öΩ", title: "Sports", hint: "What sports do you like?",
        words: [
          { en: "run", ja: "Ëµ∞„Çã", level: 1 }, { en: "ball", ja: "„Éú„Éº„É´", level: 1 },
          { en: "win", ja: "Âãù„Å§", level: 1 }, { en: "team", ja: "„ÉÅ„Éº„É†", level: 1 },
          { en: "swim", ja: "Ê≥≥„Åê", level: 1 }, { en: "tennis", ja: "„ÉÜ„Éã„Çπ", level: 1 },
          { en: "soccer", ja: "„Çµ„ÉÉ„Ç´„Éº", level: 2 }, { en: "baseball", ja: "ÈáéÁêÉ", level: 2 },
          { en: "player", ja: "ÈÅ∏Êâã", level: 2 }, { en: "strong", ja: "Âº∑„ÅÑ", level: 2 },
          { en: "practice", ja: "Á∑¥Áøí„Åô„Çã", level: 2 }, { en: "match", ja: "Ë©¶Âêà", level: 2 },
          { en: "athlete", ja: "ÈÅãÂãïÈÅ∏Êâã", level: 3 }, { en: "opponent", ja: "Áõ∏Êâã", level: 3 },
          { en: "stadium", ja: "Á´∂ÊäÄÂ†¥", level: 3 }, { en: "exciting", ja: "„Çè„Åè„Çè„Åè„Åô„Çã", level: 3 }
        ]
      },
      { 
        emoji: "üîÆ", title: "Future", hint: "What do you want to be?",
        words: [
          { en: "job", ja: "‰ªï‰∫ã", level: 1 }, { en: "dream", ja: "Â§¢", level: 1 },
          { en: "money", ja: "„ÅäÈáë", level: 1 }, { en: "teacher", ja: "ÂÖàÁîü", level: 1 },
          { en: "doctor", ja: "ÂåªËÄÖ", level: 1 }, { en: "cook", ja: "ÊñôÁêÜ‰∫∫", level: 1 },
          { en: "work", ja: "ÂÉç„Åè", level: 2 }, { en: "company", ja: "‰ºöÁ§æ", level: 2 },
          { en: "abroad", ja: "Êµ∑Â§ñ„Åß", level: 2 }, { en: "rich", ja: "ÈáëÊåÅ„Å°„ÅÆ", level: 2 },
          { en: "nurse", ja: "ÁúãË≠∑Â∏´", level: 2 }, { en: "decide", ja: "Ê±∫„ÇÅ„Çã", level: 2 },
          { en: "society", ja: "Á§æ‰ºö", level: 3 }, { en: "university", ja: "Â§ßÂ≠¶", level: 3 },
          { en: "engineer", ja: "ÊäÄÂ∏´", level: 3 }, { en: "success", ja: "ÊàêÂäü", level: 3 }
        ]
      },
      { 
        emoji: "üé¨", title: "Movie", hint: "What is your favorite movie?",
        words: [
          { en: "watch", ja: "Ë¶ã„Çã", level: 1 }, { en: "movie", ja: "Êò†Áîª", level: 1 },
          { en: "fun", ja: "Ê•Ω„Åó„ÅÑ", level: 1 }, { en: "sad", ja: "ÊÇ≤„Åó„ÅÑ", level: 1 },
          { en: "story", ja: "Áâ©Ë™û", level: 1 }, { en: "hero", ja: "Ëã±ÈõÑ", level: 1 },
          { en: "cinema", ja: "Êò†ÁîªÈ§®", level: 2 }, { en: "actor", ja: "‰ø≥ÂÑ™", level: 2 },
          { en: "anime", ja: "„Ç¢„Éã„É°", level: 2 }, { en: "comedy", ja: "ÂñúÂäá", level: 2 },
          { en: "action", ja: "„Ç¢„ÇØ„Ç∑„Éß„É≥", level: 2 }, { en: "character", ja: "ÁôªÂ†¥‰∫∫Áâ©", level: 2 },
          { en: "scene", ja: "Â†¥Èù¢", level: 3 }, { en: "director", ja: "Áõ£Áù£", level: 3 },
          { en: "emotional", ja: "ÊÑüÊÉÖÁöÑ„Å™", level: 3 }, { en: "exciting", ja: "„Çè„Åè„Çè„Åè„Åô„Çã", level: 3 }
        ]
      },
      { 
        emoji: "ü¶Å", title: "Animal", hint: "What animal do you like?",
        words: [
          { en: "dog", ja: "Áä¨", level: 1 }, { en: "cat", ja: "Áå´", level: 1 },
          { en: "bird", ja: "È≥•", level: 1 }, { en: "fish", ja: "È≠ö", level: 1 },
          { en: "cute", ja: "„Åã„Çè„ÅÑ„ÅÑ", level: 1 }, { en: "big", ja: "Â§ß„Åç„ÅÑ", level: 1 },
          { en: "pet", ja: "„Éö„ÉÉ„Éà", level: 2 }, { en: "zoo", ja: "ÂãïÁâ©Âúí", level: 2 },
          { en: "rabbit", ja: "„Ç¶„Çµ„ÇÆ", level: 2 }, { en: "strong", ja: "Âº∑„ÅÑ", level: 2 },
          { en: "fast", ja: "ÈÄü„ÅÑ", level: 2 }, { en: "wild", ja: "ÈáéÁîü„ÅÆ", level: 2 },
          { en: "protect", ja: "ÂÆà„Çã", level: 3 }, { en: "nature", ja: "Ëá™ÁÑ∂", level: 3 },
          { en: "dangerous", ja: "Âç±Èô∫„Å™", level: 3 }, { en: "species", ja: "Á®Æ", level: 3 }
        ]
      },
      { 
        emoji: "üìö", title: "Book", hint: "Do you like to read books?",
        words: [
          { en: "read", ja: "Ë™≠„ÇÄ", level: 1 }, { en: "book", ja: "Êú¨", level: 1 },
          { en: "buy", ja: "Ë≤∑„ÅÜ", level: 1 }, { en: "picture", ja: "Áµµ", level: 1 },
          { en: "story", ja: "Áâ©Ë™û", level: 1 }, { en: "long", ja: "Èï∑„ÅÑ", level: 1 },
          { en: "library", ja: "Âõ≥Êõ∏È§®", level: 2 }, { en: "novel", ja: "Â∞èË™¨", level: 2 },
          { en: "comic", ja: "Êº´Áîª", level: 2 }, { en: "interesting", ja: "Èù¢ÁôΩ„ÅÑ", level: 2 },
          { en: "learn", ja: "Â≠¶„Å∂", level: 2 }, { en: "writer", ja: "‰ΩúÂÆ∂", level: 2 },
          { en: "author", ja: "ËëóËÄÖ", level: 3 }, { en: "knowledge", ja: "Áü•Ë≠ò", level: 3 },
          { en: "fantasy", ja: "Á©∫ÊÉ≥", level: 3 }, { en: "vocabulary", ja: "Ë™ûÂΩô", level: 3 }
        ]
      },
      { 
        emoji: "üé®", title: "Color", hint: "What is your favorite color?",
        words: [
          { en: "red", ja: "Ëµ§", level: 1 }, { en: "blue", ja: "Èùí", level: 1 },
          { en: "white", ja: "ÁôΩ", level: 1 }, { en: "black", ja: "Èªí", level: 1 },
          { en: "green", ja: "Á∑ë", level: 1 }, { en: "yellow", ja: "ÈªÑËâ≤", level: 1 },
          { en: "color", ja: "Ëâ≤", level: 2 }, { en: "bright", ja: "Êòé„Çã„ÅÑ", level: 2 },
          { en: "dark", ja: "Êöó„ÅÑ", level: 2 }, { en: "light", ja: "ËñÑ„ÅÑ/ËªΩ„ÅÑ", level: 2 },
          { en: "sky", ja: "Á©∫", level: 2 }, { en: "flower", ja: "Ëä±", level: 2 },
          { en: "image", ja: "Âç∞Ë±°", level: 3 }, { en: "feeling", ja: "ÊÑüÊÉÖ", level: 3 },
          { en: "clothes", ja: "Êúç", level: 3 }, { en: "paint", ja: "Áµµ„ÅÆÂÖ∑", level: 3 }
        ]
      },
      { 
        emoji: "üéÜ", title: "Festival", hint: "What festival do you enjoy most?",
        words: [
          { en: "summer", ja: "Â§è", level: 1 }, { en: "food", ja: "È£ü„ÅπÁâ©", level: 1 },
          { en: "go", ja: "Ë°å„Åè", level: 1 }, { en: "see", ja: "Ë¶ã„Çã", level: 1 },
          { en: "friend", ja: "ÂèãÈÅî", level: 1 }, { en: "night", ja: "Â§ú", level: 1 },
          { en: "festival", ja: "Á•≠„Çä", level: 2 }, { en: "firework", ja: "Ëä±ÁÅ´", level: 2 },
          { en: "wear", ja: "ÁùÄ„Çã", level: 2 }, { en: "dance", ja: "Ë∏ä„Çä", level: 2 },
          { en: "shrine", ja: "Á•ûÁ§æ", level: 2 }, { en: "crowd", ja: "‰∫∫Ê∑∑„Åø", level: 2 },
          { en: "tradition", ja: "‰ºùÁµ±", level: 3 }, { en: "celebrate", ja: "Á•ù„ÅÜ", level: 3 },
          { en: "atmosphere", ja: "Èõ∞Âõ≤Ê∞ó", level: 3 }, { en: "event", ja: "Ë°å‰∫ã", level: 3 }
        ]
      },
      { 
        emoji: "üêï", title: "Pet", hint: "Do you have a pet?",
        words: [
          { en: "dog", ja: "Áä¨", level: 1 }, { en: "cat", ja: "Áå´", level: 1 },
          { en: "cute", ja: "„Åã„Çè„ÅÑ„ÅÑ", level: 1 }, { en: "small", ja: "Â∞è„Åï„ÅÑ", level: 1 },
          { en: "want", ja: "Ê¨≤„Åó„ÅÑ", level: 1 }, { en: "house", ja: "ÂÆ∂", level: 1 },
          { en: "walk", ja: "Êï£Ê≠©", level: 2 }, { en: "name", ja: "ÂêçÂâç", level: 2 },
          { en: "feed", ja: "È§å„Çí„ÇÑ„Çã", level: 2 }, { en: "together", ja: "‰∏ÄÁ∑í„Å´", level: 2 },
          { en: "rabbit", ja: "„Ç¶„Çµ„ÇÆ", level: 2 }, { en: "bird", ja: "È≥•", level: 2 },
          { en: "care", ja: "‰∏ñË©±", level: 3 }, { en: "responsibility", ja: "Ë≤¨‰ªª", level: 3 },
          { en: "comfort", ja: "ÊÖ∞„ÇÅ", level: 3 }, { en: "furry", ja: "ÊØõÁöÆ„ÅÆ", level: 3 }
        ]
      },
      { 
        emoji: "üèôÔ∏è", title: "Place", hint: "What is your favorite place in your town?",
        words: [
          { en: "park", ja: "ÂÖ¨Âúí", level: 1 }, { en: "shop", ja: "Â∫ó", level: 1 },
          { en: "school", ja: "Â≠¶Ê†°", level: 1 }, { en: "station", ja: "ÈßÖ", level: 1 },
          { en: "house", ja: "ÂÆ∂", level: 1 }, { en: "near", ja: "Ëøë„ÅÑ", level: 1 },
          { en: "library", ja: "Âõ≥Êõ∏È§®", level: 2 }, { en: "cafe", ja: "„Ç´„Éï„Çß", level: 2 },
          { en: "quiet", ja: "Èùô„Åã„Å™", level: 2 }, { en: "beautiful", ja: "Áæé„Åó„ÅÑ", level: 2 },
          { en: "mall", ja: "„É¢„Éº„É´", level: 2 }, { en: "view", ja: "Áú∫„ÇÅ", level: 2 },
          { en: "convenient", ja: "‰æøÂà©„Å™", level: 3 }, { en: "relax", ja: "„É™„É©„ÉÉ„ÇØ„Çπ„Åô„Çã", level: 3 },
          { en: "nature", ja: "Ëá™ÁÑ∂", level: 3 }, { en: "building", ja: "Âª∫Áâ©", level: 3 }
        ]
      },
      { 
        emoji: "ü•§", title: "Drink", hint: "What do you like to drink?",
        words: [
          { en: "water", ja: "Ê∞¥", level: 1 }, { en: "milk", ja: "Áâõ‰π≥", level: 1 },
          { en: "tea", ja: "„ÅäËå∂", level: 1 }, { en: "juice", ja: "„Ç∏„É•„Éº„Çπ", level: 1 },
          { en: "hot", ja: "ÁÜ±„ÅÑ", level: 1 }, { en: "cold", ja: "ÂÜ∑„Åü„ÅÑ", level: 1 },
          { en: "coffee", ja: "„Ç≥„Éº„Éí„Éº", level: 2 }, { en: "sweet", ja: "Áîò„ÅÑ", level: 2 },
          { en: "soda", ja: "ÁÇ≠ÈÖ∏", level: 2 }, { en: "bottle", ja: "Áì∂/„Éú„Éà„É´", level: 2 },
          { en: "ice", ja: "Ê∞∑", level: 2 }, { en: "healthy", ja: "ÂÅ•Â∫∑ÁöÑ„Å™", level: 2 },
          { en: "flavor", ja: "È¢®Âë≥", level: 3 }, { en: "thirsty", ja: "Âñâ„ÅåÊ∏á„ÅÑ„Åü", level: 3 },
          { en: "cafe", ja: "„Ç´„Éï„Çß", level: 3 }, { en: "contain", ja: "Âê´„ÇÄ", level: 3 }
        ]
      },
      { 
        emoji: "üòì", title: "Hard Subject", hint: "Which subject is difficult for you?",
        words: [
          { en: "math", ja: "Êï∞Â≠¶", level: 1 }, { en: "English", ja: "Ëã±Ë™û", level: 1 },
          { en: "science", ja: "ÁêÜÁßë", level: 1 }, { en: "test", ja: "„ÉÜ„Çπ„Éà", level: 1 },
          { en: "bad", ja: "ÊÇ™„ÅÑ", level: 1 }, { en: "hard", ja: "Èõ£„Åó„ÅÑ", level: 1 },
          { en: "history", ja: "Ê≠¥Âè≤", level: 2 }, { en: "score", ja: "ÁÇπÊï∞", level: 2 },
          { en: "homework", ja: "ÂÆøÈ°å", level: 2 }, { en: "boring", ja: "ÈÄÄÂ±à„Å™", level: 2 },
          { en: "understand", ja: "ÁêÜËß£„Åô„Çã", level: 2 }, { en: "grade", ja: "ÊàêÁ∏æ", level: 2 },
          { en: "memorize", ja: "ÊöóË®ò„Åô„Çã", level: 3 }, { en: "explain", ja: "Ë™¨Êòé„Åô„Çã", level: 3 },
          { en: "concentrate", ja: "ÈõÜ‰∏≠„Åô„Çã", level: 3 }, { en: "improve", ja: "Âêë‰∏ä„Åï„Åõ„Çã", level: 3 }
        ]
      },
      { 
        emoji: "üìÖ", title: "Weekend", hint: "How do you spend your weekends?",
        words: [
          { en: "sleep", ja: "ÂØù„Çã", level: 1 }, { en: "play", ja: "ÈÅä„Å∂", level: 1 },
          { en: "go", ja: "Ë°å„Åè", level: 1 }, { en: "home", ja: "ÂÆ∂", level: 1 },
          { en: "study", ja: "ÂãâÂº∑„Åô„Çã", level: 1 }, { en: "friend", ja: "ÂèãÈÅî", level: 1 },
          { en: "shopping", ja: "Ë≤∑„ÅÑÁâ©", level: 2 }, { en: "clean", ja: "ÊéÉÈô§„Åô„Çã", level: 2 },
          { en: "park", ja: "ÂÖ¨Âúí", level: 2 }, { en: "club", ja: "ÈÉ®Ê¥ª", level: 2 },
          { en: "family", ja: "ÂÆ∂Êóè", level: 2 }, { en: "tired", ja: "Áñ≤„Çå„Åü", level: 2 },
          { en: "relax", ja: "„É™„É©„ÉÉ„ÇØ„Çπ„Åô„Çã", level: 3 }, { en: "active", ja: "Ê¥ªÂãïÁöÑ„Å™", level: 3 },
          { en: "hobby", ja: "Ë∂£Âë≥", level: 3 }, { en: "schedule", ja: "‰∫àÂÆö", level: 3 }
        ]
      },
      { 
        emoji: "üëæ", title: "Game", hint: "What games do you play?",
        words: [
          { en: "play", ja: "ÈÅä„Å∂", level: 1 }, { en: "fun", ja: "Ê•Ω„Åó„ÅÑ", level: 1 },
          { en: "win", ja: "Âãù„Å§", level: 1 }, { en: "lose", ja: "Ë≤†„Åë„Çã", level: 1 },
          { en: "friend", ja: "ÂèãÈÅî", level: 1 }, { en: "time", ja: "ÊôÇÈñì", level: 1 },
          { en: "video", ja: "„Éì„Éá„Ç™", level: 2 }, { en: "phone", ja: "ÈõªË©±/„Çπ„Éû„Éõ", level: 2 },
          { en: "online", ja: "„Ç™„É≥„É©„Ç§„É≥", level: 2 }, { en: "character", ja: "„Ç≠„É£„É©", level: 2 },
          { en: "level", ja: "„É¨„Éô„É´", level: 2 }, { en: "team", ja: "„ÉÅ„Éº„É†", level: 2 },
          { en: "exciting", ja: "„Çè„Åè„Çè„Åè„Åô„Çã", level: 3 }, { en: "strategy", ja: "Êà¶Áï•", level: 3 },
          { en: "popular", ja: "‰∫∫Ê∞ó„ÅÆ„ÅÇ„Çã", level: 3 }, { en: "skill", ja: "ÊäÄË°ì", level: 3 }
        ]
      },
      { 
        emoji: "üì∫", title: "TV", hint: "What TV show do you like?",
        words: [
          { en: "watch", ja: "Ë¶ã„Çã", level: 1 }, { en: "TV", ja: "„ÉÜ„É¨„Éì", level: 1 },
          { en: "like", ja: "Â•Ω„Åç", level: 1 }, { en: "funny", ja: "Èù¢ÁôΩ„ÅÑ", level: 1 },
          { en: "every", ja: "ÊØé‚Ä¶", level: 1 }, { en: "week", ja: "ÈÄ±", level: 1 },
          { en: "news", ja: "„Éã„É•„Éº„Çπ", level: 2 }, { en: "drama", ja: "„Éâ„É©„Éû", level: 2 },
          { en: "anime", ja: "„Ç¢„Éã„É°", level: 2 }, { en: "sport", ja: "„Çπ„Éù„Éº„ÉÑ", level: 2 },
          { en: "variety", ja: "„Éê„É©„Ç®„ÉÜ„Ç£", level: 2 }, { en: "actor", ja: "‰ø≥ÂÑ™", level: 2 },
          { en: "program", ja: "Áï™ÁµÑ", level: 3 }, { en: "series", ja: "„Ç∑„É™„Éº„Ç∫", level: 3 },
          { en: "channel", ja: "„ÉÅ„É£„É≥„Éç„É´", level: 3 }, { en: "interesting", ja: "ËààÂë≥Ê∑±„ÅÑ", level: 3 }
        ]
      }
    ];

    // BGM URL (Cafe Jazz / Relaxing)
    const BGM_SOURCES = [
      "https://cdn.pixabay.com/download/audio/2022/03/23/audio_07b2a04be3.mp3", // Coffee Shop Jazz
      "https://cdn.pixabay.com/download/audio/2022/11/22/audio_febc508520.mp3"  // Upbeat Jazz
    ];
    
    // ÂäπÊûúÈü≥ (SE) URL - Áü≠„ÅÑÈü≥„ÇíÊé°Áî®Ôºà„Éî„Ç≥„É≥/PopÈü≥Ôºâ
    const SE_POINT = "https://cdn.pixabay.com/download/audio/2022/03/15/audio_c8c8a73467.mp3"; // Pop Sound
    // ÁµÇ‰∫ÜÊôÇ„ÅÆÂäπÊûúÈü≥ (SE) URL - „Éõ„Ç§„ÉÉ„Çπ„É´
    const SE_FINISH = "https://cdn.pixabay.com/download/audio/2021/08/04/audio_c6718d7197.mp3"; // Whistle

    // „Éù„Ç§„É≥„ÉàÂÆöÁæ©
    const POINTS = {
      1: 10,
      2: 20,
      3: 30
    };

    // --- „Ç≥„É≥„Éù„Éº„Éç„É≥„ÉàÂÆöÁæ© (ÂÜç„É¨„É≥„ÉÄ„É™„É≥„Ç∞Èò≤Ê≠¢„ÅÆ„Åü„ÇÅApp„ÅÆÂ§ñ„Å∏) ---

    const WinnerOverlay = ({ timeLeft, scoreA, scoreB, initNewGame }) => {
      if (timeLeft > 0) return null;
      
      let resultTitle = "";
      let resultColor = "";
      if (scoreA > scoreB) {
        resultTitle = "WINNER: PLAYER A";
        resultColor = "text-blue-600";
      } else if (scoreB > scoreA) {
        resultTitle = "WINNER: PLAYER B";
        resultColor = "text-pink-600";
      } else {
        resultTitle = "DRAW!";
        resultColor = "text-purple-600";
      }

      return (
        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center animate-in fade-in duration-500 backdrop-blur-sm">
          <div className="bg-white p-8 md:p-12 rounded-3xl shadow-2xl text-center transform animate-in zoom-in duration-300 max-w-2xl w-full mx-4 border-4 border-yellow-400">
            <Crown size={80} className={`mx-auto mb-4 ${resultColor} animate-bounce`} />
            <h2 className={`text-4xl md:text-5xl font-black ${resultColor} mb-6`}>{resultTitle}</h2>
            
            <div className="flex justify-center gap-8 md:gap-16 mb-8">
              <div className="bg-blue-50 p-4 rounded-xl w-32">
                <div className="text-sm font-bold text-blue-400">Player A</div>
                <div className="text-4xl font-black text-blue-600">{scoreA}</div>
              </div>
              <div className="bg-pink-50 p-4 rounded-xl w-32">
                <div className="text-sm font-bold text-pink-400">Player B</div>
                <div className="text-4xl font-black text-pink-600">{scoreB}</div>
              </div>
            </div>

            <button 
              onClick={initNewGame} 
              className="w-full py-4 bg-slate-800 text-white rounded-xl font-bold text-xl hover:bg-slate-700 hover:scale-[1.02] transition-all shadow-lg flex items-center justify-center gap-2"
            >
              <RefreshCw /> Play Again
            </button>
          </div>
        </div>
      );
    };

    const MenuScreen = ({ gameTimeSetting, setGameTimeSetting, initNewGame }) => (
      <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50 p-6 font-sans text-slate-800">
        <div className="bg-white p-10 rounded-3xl shadow-xl w-full max-w-md text-center border border-slate-200">
          <div className="mb-6 flex justify-center">
            <div className="bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-4 rounded-2xl shadow-lg">
              <Trophy size={48} />
            </div>
          </div>
          <h1 className="text-4xl font-black mb-2 text-slate-900 tracking-tight">
            PAIR SPEAKING<br/>CHALLENGE
          </h1>
          <p className="text-slate-500 mb-8 font-medium">Earn points by using English!</p>

          {/* Time Settings */}
          <div className="mb-6 bg-slate-100 p-4 rounded-xl">
            <label className="block text-sm font-bold text-slate-600 mb-2 flex justify-between">
              <span>Time Limit:</span>
              <span className="text-indigo-600 text-lg">{gameTimeSetting} sec</span>
            </label>
            <input 
              type="range" 
              min="30" 
              max="180" 
              step="10" 
              value={gameTimeSetting} 
              onChange={(e) => setGameTimeSetting(Number(e.target.value))}
              className="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-indigo-600"
            />
            <div className="flex justify-between text-xs text-slate-400 mt-1">
              <span>30s</span>
              <span>180s</span>
            </div>
          </div>

          <div className="space-y-4 mb-8 text-left bg-slate-50 p-4 rounded-xl border border-slate-100">
            <h3 className="font-bold text-slate-700 flex items-center gap-2">
              <Star size={16} className="text-yellow-500" fill="currentColor"/> Points System
            </h3>
            <ul className="text-sm space-y-2 text-slate-600">
              <li className="flex justify-between items-center">
                <span><span className="bg-blue-500 text-white px-1.5 rounded-full text-[10px] mr-2 font-bold">L1</span>Basic Words</span>
                <span className="font-bold text-blue-600">+10 pt</span>
              </li>
              <li className="flex justify-between items-center">
                <span><span className="bg-emerald-500 text-white px-1.5 rounded-full text-[10px] mr-2 font-bold">L2</span>Grade 3</span>
                <span className="font-bold text-emerald-600">+20 pt</span>
              </li>
              <li className="flex justify-between items-center">
                <span><span className="bg-yellow-500 text-white px-1.5 rounded-full text-[10px] mr-2 font-bold">L3</span>Grade Pre-2</span>
                <span className="font-bold text-yellow-600">+30 pt</span>
              </li>
            </ul>
          </div>

          <button
            onClick={initNewGame}
            className="w-full bg-slate-900 text-white py-5 rounded-2xl text-xl font-bold shadow-xl hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-3"
          >
            <Play fill="currentColor" /> START GAME
          </button>
        </div>
      </div>
    );

    const GameScreen = ({ 
      timeLeft, 
      gameTimeSetting, 
      isActive,
      scoreA, 
      scoreB, 
      animateScoreA, 
      animateScoreB,
      currentTopic,
      activeCards,
      cardStatus,
      handleCardClick,
      nextTopic,
      startGame,
      initNewGame,
      setMode,
      isMuted,
      setIsMuted
    }) => {
      const progress = (timeLeft / gameTimeSetting) * 100;

      return (
        <div className="flex flex-col h-screen bg-slate-100 text-slate-800 overflow-hidden font-sans">
          
          {/* Top Bar */}
          <div className="bg-white shadow-sm border-b px-4 py-2 flex justify-between items-center shrink-0 h-16">
            <button onClick={() => setMode('menu')} className="text-slate-400 font-bold text-xs hover:text-slate-600 px-2 py-1 rounded border border-transparent hover:border-slate-200">
              EXIT
            </button>
            
            {/* Score Display */}
            <div className="flex items-center gap-4 md:gap-12 flex-1 justify-center">
              {/* Player A */}
              <div className={`flex flex-col items-center transition-transform ${animateScoreA ? 'scale-125' : 'scale-100'}`}>
                <span className="text-[10px] font-black text-blue-500 tracking-widest">PLAYER A</span>
                <span className={`text-3xl font-black text-blue-600 leading-none ${animateScoreA ? 'score-pop' : ''}`}>{scoreA}</span>
              </div>
              
              {/* Timer */}
              <div className={`flex flex-col items-center w-20 ${timeLeft < 10 ? 'text-red-500 animate-pulse' : 'text-slate-700'}`}>
                <Clock size={18} className="mb-0.5 opacity-50" />
                <span className="text-2xl font-mono font-bold leading-none">{timeLeft}</span>
              </div>

              {/* Player B */}
              <div className={`flex flex-col items-center transition-transform ${animateScoreB ? 'scale-125' : 'scale-100'}`}>
                <span className="text-[10px] font-black text-pink-500 tracking-widest">PLAYER B</span>
                <span className={`text-3xl font-black text-pink-600 leading-none ${animateScoreB ? 'score-pop' : ''}`}>{scoreB}</span>
              </div>
            </div>

            <button onClick={() => setIsMuted(!isMuted)} className="text-slate-400 hover:text-slate-600 p-2">
              {isMuted ? <VolumeX size={20} /> : <Volume2 size={20} />}
            </button>
          </div>

          {/* Progress Bar */}
          <div className="w-full bg-slate-200 h-2 shrink-0">
            <div 
              className={`h-full transition-all duration-1000 linear ${timeLeft < 10 ? 'bg-red-500' : 'bg-gradient-to-r from-blue-400 to-pink-400'}`} 
              style={{ width: `${progress}%` }}
            ></div>
          </div>

          {/* Main Game Area */}
          <div className="flex-1 flex flex-col p-2 md:p-4 gap-4 overflow-hidden max-w-6xl mx-auto w-full">
            
            {/* Topic Header - Animated Entrance with emphasized button */}
            <div 
              key={currentTopic.title}
              onClick={nextTopic}
              className="topic-enter bg-white rounded-2xl shadow-md border-b-4 border-indigo-100 p-2 md:p-4 flex flex-col items-center justify-center text-center shrink-0 relative cursor-pointer hover:bg-indigo-50 transition-all group"
            >
              <div className="absolute top-2 right-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 transition-colors shadow-sm btn-bounce">
                <SkipForward size={14}/> NEXT
              </div>
              <div className="flex items-center gap-2 mb-1">
                <span className="text-3xl md:text-4xl animate-bounce">{currentTopic.emoji}</span>
                <h2 className="text-lg md:text-2xl font-black text-slate-800 uppercase tracking-tight">{currentTopic.title}</h2>
              </div>
              <p className="text-slate-500 font-medium text-xs md:text-lg line-clamp-2">"{currentTopic.hint}"</p>
            </div>

            {/* Cards Grid - 3x2 Layout (Responsive) */}
            <div className="flex-1 relative">
              {/* Start Button Overlay */}
              {!isActive && timeLeft === gameTimeSetting && (
                <div className="absolute inset-0 z-20 flex items-center justify-center bg-white/50 backdrop-blur-[2px] rounded-xl">
                   <button 
                     onClick={startGame} 
                     className="group relative bg-slate-900 text-white px-10 py-6 rounded-full font-black text-3xl shadow-2xl hover:scale-105 transition-transform flex items-center gap-4 overflow-hidden"
                   >
                     <div className="absolute inset-0 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                     <span className="relative flex items-center gap-3 z-10"><Play fill="currentColor" /> START</span>
                   </button>
                </div>
              )}

              <div className="grid grid-cols-3 gap-2 md:gap-4 h-full content-stretch">
                {activeCards.map((card, idx) => {
                  const status = cardStatus[idx]; // 'A' or 'B' or null
                  const isUsed = !!status;
                  const points = POINTS[card.level];
                  
                  // Ëâ≤ÂàÜ„Åë
                  let borderClass = "";
                  let bgClass = "";
                  let badgeColor = "";
                  let levelLabel = "";

                  if (card.level === 1) {
                    borderClass = "border-blue-200";
                    bgClass = "bg-blue-50/30";
                    badgeColor = "bg-blue-500";
                    levelLabel = "L1 (+10)";
                  } else if (card.level === 2) {
                    borderClass = "border-emerald-200";
                    bgClass = "bg-emerald-50/30";
                    badgeColor = "bg-emerald-500";
                    levelLabel = "L2 (+20)";
                  } else {
                    borderClass = "border-yellow-200";
                    bgClass = "bg-yellow-50/30";
                    badgeColor = "bg-yellow-500";
                    levelLabel = "L3 (+30)";
                  }

                  return (
                    <div 
                      key={idx}
                      className={`
                        relative rounded-xl border-2 shadow-sm overflow-hidden flex flex-col justify-between transition-all select-none
                        ${borderClass} ${bgClass}
                        ${isUsed ? 'opacity-50 grayscale scale-95' : 'hover:shadow-md'}
                      `}
                    >
                      {/* Header Badge */}
                      <div className="flex justify-between items-center px-2 py-1 bg-white/50 border-b border-black/5">
                        <span className={`text-[10px] font-bold text-white px-1.5 rounded-full ${badgeColor}`}>
                          {levelLabel}
                        </span>
                      </div>

                      {/* Card Content */}
                      <div className="flex-1 flex flex-col items-center justify-center p-1 text-center">
                        <div className="font-bold text-base md:text-xl leading-tight mb-1 text-slate-800 break-words w-full">{card.en}</div>
                        <div className="text-[10px] md:text-xs text-slate-500">{card.ja}</div>
                      </div>

                      {/* Action Buttons (1-Tap Areas) - Always Visible but styled */}
                      {!isUsed && (
                        <div className="flex h-12 md:h-16 border-t border-slate-300/30">
                          <button 
                            className="flex-1 bg-blue-500/10 hover:bg-blue-500/20 active:bg-blue-500/40 text-blue-600 font-black text-lg flex items-center justify-center transition-colors border-r border-slate-300/30"
                            onClick={(e) => { e.stopPropagation(); handleCardClick(idx, 'A'); }}
                          >
                            A
                          </button>
                          <button 
                            className="flex-1 bg-pink-500/10 hover:bg-pink-500/20 active:bg-pink-500/40 text-pink-600 font-black text-lg flex items-center justify-center transition-colors"
                            onClick={(e) => { e.stopPropagation(); handleCardClick(idx, 'B'); }}
                          >
                            B
                          </button>
                        </div>
                      )}

                      {/* Taken Overlay */}
                      {isUsed && (
                        <div className="absolute inset-0 flex items-center justify-center bg-slate-100/80 z-20 backdrop-blur-[1px]">
                           <div className={`text-4xl md:text-5xl font-black ${status === 'A' ? 'text-blue-500' : 'text-pink-500'}`}>
                             {status}
                           </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
          
          <WinnerOverlay 
            timeLeft={timeLeft} 
            scoreA={scoreA} 
            scoreB={scoreB} 
            initNewGame={initNewGame} 
          />
        </div>
      );
    };

    function App() {
      // --- State Management ---
      const [mode, setMode] = useState('menu'); // 'menu' | 'game'
      
      // Game Data
      const [currentTopic, setCurrentTopic] = useState(TOPICS_DATA[0]);
      const [activeCards, setActiveCards] = useState([]);
      
      // Game Status
      const [gameTimeSetting, setGameTimeSetting] = useState(60); // „Éá„Éï„Ç©„É´„Éà60Áßí
      const [timeLeft, setTimeLeft] = useState(60);
      const [isActive, setIsActive] = useState(false);
      
      // Scoring: Player A vs Player B
      const [scoreA, setScoreA] = useState(0);
      const [scoreB, setScoreB] = useState(0);
      
      // Score Animation State (trigger animation when score changes)
      const [animateScoreA, setAnimateScoreA] = useState(false);
      const [animateScoreB, setAnimateScoreB] = useState(false);
      
      // Card Ownership: { index: 'A' | 'B' | null }
      const [cardStatus, setCardStatus] = useState({});

      // Audio
      const [isMuted, setIsMuted] = useState(false);
      const audioRef = useRef(null);
      const seRef = useRef(null); // SEÁî®Ref
      const finishSeRef = useRef(null); // ÁµÇ‰∫ÜÈü≥Áî®Ref

      const timerRef = useRef(null);

      // --- Logic ---
      
      // SEÂÜçÁîü
      const playSe = () => {
        if (!isMuted && seRef.current) {
          seRef.current.currentTime = 0;
          seRef.current.volume = 1.0;
          seRef.current.play().catch(e => console.log("SE Playback failed", e));
        }
      };

      // „Çπ„Ç≥„Ç¢„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áô∫ÁÅ´
      useEffect(() => {
        if (scoreA > 0) {
          setAnimateScoreA(true);
          const t = setTimeout(() => setAnimateScoreA(false), 300);
          return () => clearTimeout(t);
        }
      }, [scoreA]);

      useEffect(() => {
        if (scoreB > 0) {
          setAnimateScoreB(true);
          const t = setTimeout(() => setAnimateScoreB(false), 300);
          return () => clearTimeout(t);
        }
      }, [scoreB]);

      // „Éà„Éî„ÉÉ„ÇØ„Å®„Ç´„Éº„Éâ„Çí„É©„É≥„ÉÄ„É†„Å´Ë®≠ÂÆöÔºà„Çπ„Ç≥„Ç¢„ÉªÊôÇÈñì„ÅØ„Ç™„Éó„Ç∑„Éß„É≥„Åß„É™„Çª„ÉÉ„ÉàÔºâ
      const setupRound = (resetStats = false) => {
        // „É©„É≥„ÉÄ„É†„Éà„Éî„ÉÉ„ÇØ
        const randomTopic = TOPICS_DATA[Math.floor(Math.random() * TOPICS_DATA.length)];
        setCurrentTopic(randomTopic);

        // „Ç´„Éº„ÉâÈÅ∏Âá∫„É≠„Ç∏„ÉÉ„ÇØ: ÂêÑ„É¨„Éô„É´„Åã„Çâ„Éê„É©„É≥„Çπ„Çà„ÅèÈÅ∏Âá∫
        const l1 = (randomTopic.words || []).filter(w => w.level === 1).sort(() => 0.5 - Math.random()).slice(0, 2);
        const l2 = (randomTopic.words || []).filter(w => w.level === 2).sort(() => 0.5 - Math.random()).slice(0, 2);
        const l3 = (randomTopic.words || []).filter(w => w.level === 3).sort(() => 0.5 - Math.random()).slice(0, 2);
        
        // Ê∑∑„Åú„Çã
        const mixed = [...l1, ...l2, ...l3].sort(() => 0.5 - Math.random());
        setActiveCards(mixed);

        // „Ç´„Éº„ÉâÁä∂ÊÖã„É™„Çª„ÉÉ„ÉàÔºàÊñ∞„Åó„ÅÑ„Ç´„Éº„Éâ„Å´„Å™„Çã„Åü„ÇÅÔºâ
        setCardStatus({});

        if (resetStats) {
          setScoreA(0);
          setScoreB(0);
          setTimeLeft(gameTimeSetting); // Ë®≠ÂÆöÊôÇÈñì„Çí‰ΩøÁî®
          setIsActive(false);
          // Èü≥Ê•ΩÂÅúÊ≠¢
          if (audioRef.current) {
            audioRef.current.pause();
            audioRef.current.currentTime = 0;
          }
        }
      };

      // ÂÆåÂÖ®„Å´Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†„ÇíÈñãÂßãÔºà„É™„Çª„ÉÉ„Éà„ÅÇ„ÇäÔºâ
      const initNewGame = () => {
        setupRound(true);
        setMode('game');
      };

      // Ê¨°„ÅÆ„Éà„Éî„ÉÉ„ÇØ„Å∏ÈÄ≤„ÇÄÔºà„Çπ„Ç≥„Ç¢„ÉªÊôÇÈñìÁ∂≠ÊåÅÔºâ
      const nextTopic = () => {
        setupRound(false);
      };

      const startGame = () => {
        setIsActive(true);
        
        // BGMÂÜçÁîü
        if (!isMuted && audioRef.current) {
          const randomSrc = BGM_SOURCES[Math.floor(Math.random() * BGM_SOURCES.length)];
          audioRef.current.src = randomSrc;
          audioRef.current.volume = 0.3; 
          
          const playPromise = audioRef.current.play();
          if (playPromise !== undefined) {
            playPromise.catch(error => {
              console.log("Audio playback was prevented or interrupted:", error);
            });
          }
        }
      };

      // „Çø„Ç§„Éû„Éº
      useEffect(() => {
        if (isActive && timeLeft > 0) {
          timerRef.current = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
        } else if (timeLeft === 0 && isActive) {
          setIsActive(false);
          if (audioRef.current) {
            audioRef.current.pause();
            audioRef.current.currentTime = 0;
          }
          // ÁµÇ‰∫ÜÈü≥ÂÜçÁîü
          if (!isMuted && finishSeRef.current) {
             finishSeRef.current.currentTime = 0;
             finishSeRef.current.play().catch(e => console.log(e));
          }
        }
        return () => {
          if (timerRef.current) clearTimeout(timerRef.current);
        };
      }, [isActive, timeLeft, isMuted]);

      // ÂÖ®„Å¶„ÅÆ„Ç´„Éº„Éâ„ÅåÂèñ„Çâ„Çå„Åü„ÅãÁõ£Ë¶ñ„Åô„Çã
      useEffect(() => {
        if (isActive && activeCards.length > 0) {
          const takenCount = Object.keys(cardStatus).length;
          if (takenCount === activeCards.length) {
            // ÂÖ®„Å¶Âèñ„Çâ„Çå„Åü„ÇâÂ∞ë„ÅóÂæÖ„Å£„Å¶Ê¨°„ÅÆ„Éà„Éî„ÉÉ„ÇØ„Å∏
            const timeout = setTimeout(() => {
              nextTopic();
            }, 800);
            return () => clearTimeout(timeout);
          }
        }
      }, [cardStatus, isActive, activeCards]);

      // „Ç´„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
      const handleCardClick = (index, player) => {
        if (!isActive && timeLeft > 0) return; // „Ç≤„Éº„É†‰∏≠„ÅÆ„Åø
        if (cardStatus[index]) return; // ÂèñÂæóÊ∏à„Åø„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ

        // SEÂÜçÁîü
        playSe();

        // ÂèñÂæóÁä∂ÊÖãÊõ¥Êñ∞
        setCardStatus(prev => ({ ...prev, [index]: player }));

        // ÁÇπÊï∞Âä†ÁÆó
        const card = activeCards[index];
        if (card) {
          const points = POINTS[card.level];
          if (player === 'A') setScoreA(s => s + points);
          else setScoreB(s => s + points);
        }
      };

      return (
        <React.Fragment>
          <audio ref={audioRef} loop preload="auto" />
          <audio ref={seRef} src={SE_POINT} preload="auto" />
          <audio ref={finishSeRef} src={SE_FINISH} preload="auto" />
          
          {mode === 'menu' && (
            <MenuScreen 
              gameTimeSetting={gameTimeSetting}
              setGameTimeSetting={setGameTimeSetting}
              initNewGame={initNewGame}
            />
          )}
          
          {mode === 'game' && (
            <GameScreen 
              timeLeft={timeLeft}
              gameTimeSetting={gameTimeSetting}
              isActive={isActive}
              scoreA={scoreA}
              scoreB={scoreB}
              animateScoreA={animateScoreA}
              animateScoreB={animateScoreB}
              currentTopic={currentTopic}
              activeCards={activeCards}
              cardStatus={cardStatus}
              handleCardClick={handleCardClick}
              nextTopic={nextTopic}
              startGame={startGame}
              initNewGame={initNewGame}
              setMode={setMode}
              isMuted={isMuted}
              setIsMuted={setIsMuted}
            />
          )}
        </React.Fragment>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
