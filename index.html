<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pair Speaking Challenge</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel (JSXÂ§âÊèõÁî®) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      touch-action: manipulation; /* „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„Ç∫„Éº„É†Èò≤Ê≠¢ */
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- „Ç¢„Ç§„Ç≥„É≥„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà ---
    const IconWrapper = ({ children, size = 24, className = "" }) => (
      <svg 
        xmlns="http://www.w3.org/2000/svg" 
        width={size} 
        height={size} 
        viewBox="0 0 24 24" 
        fill="none" 
        stroke="currentColor" 
        strokeWidth="2" 
        strokeLinecap="round" 
        strokeLinejoin="round" 
        className={className}
      >
        {children}
      </svg>
    );

    const Play = (props) => (
      <IconWrapper {...props}>
        <polygon points="5 3 19 12 5 21 5 3"></polygon>
      </IconWrapper>
    );

    const RefreshCw = (props) => (
      <IconWrapper {...props}>
        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
        <path d="M21 3v5h-5"></path>
        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
        <path d="M8 16H3v5"></path>
      </IconWrapper>
    );

    const Trophy = (props) => (
      <IconWrapper {...props}>
        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
        <path d="M4 22h16"></path>
        <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
        <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
        <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
      </IconWrapper>
    );

    const Clock = (props) => (
      <IconWrapper {...props}>
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </IconWrapper>
    );

    const Volume2 = (props) => (
      <IconWrapper {...props}>
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
      </IconWrapper>
    );

    const VolumeX = (props) => (
      <IconWrapper {...props}>
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
        <line x1="23" y1="9" x2="17" y2="15"></line>
        <line x1="17" y1="9" x2="23" y2="15"></line>
      </IconWrapper>
    );

    const Crown = (props) => (
      <IconWrapper {...props}>
        <path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"></path>
      </IconWrapper>
    );

    const Star = (props) => (
      <IconWrapper {...props}>
        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
      </IconWrapper>
    );

    // --- „Éá„Éº„ÇøÂÆöÁæ© ---

    // Êó•Â∏∏ÁöÑ„Å™„Éà„Éî„ÉÉ„ÇØ10ÂÄã„Å®ÂêÑ20ÂçòË™û
    const TOPICS_DATA = [
      { 
        emoji: "üè´",
        title: "School Life", 
        hint: "What do you like about school?",
        words: [
          { en: "teacher", ja: "ÂÖàÁîü", level: 1 }, { en: "class", ja: "ÊéàÊ•≠", level: 1 },
          { en: "friend", ja: "ÂèãÈÅî", level: 1 }, { en: "lunch", ja: "ÊòºÈ£ü", level: 1 },
          { en: "test", ja: "Ë©¶È®ì", level: 1 }, { en: "club", ja: "ÈÉ®Ê¥ª", level: 1 },
          { en: "subject", ja: "ÁßëÁõÆ", level: 2 }, { en: "uniform", ja: "Âà∂Êúç", level: 2 },
          { en: "graduate", ja: "ÂçíÊ•≠„Åô„Çã", level: 2 }, { en: "event", ja: "Ë°å‰∫ã", level: 2 },
          { en: "strict", ja: "Âé≥„Åó„ÅÑ", level: 2 }, { en: "popular", ja: "‰∫∫Ê∞ó„ÅÆ„ÅÇ„Çã", level: 2 },
          { en: "atmosphere", ja: "Èõ∞Âõ≤Ê∞ó", level: 3 }, { en: "concentrate", ja: "ÈõÜ‰∏≠„Åô„Çã", level: 3 },
          { en: "encourage", ja: "Âä±„Åæ„Åô", level: 3 }, { en: "opportunity", ja: "Ê©ü‰ºö", level: 3 },
          { en: "achievement", ja: "ÈÅîÊàê", level: 3 }, { en: "cooperate", ja: "ÂçîÂäõ„Åô„Çã", level: 3 },
          { en: "organize", ja: "ÁµÑÁπî„Åô„Çã", level: 3 }, { en: "presentation", ja: "Áô∫Ë°®", level: 3 }
        ]
      },
      { 
        emoji: "üçî",
        title: "Food", 
        hint: "What is your favorite food?",
        words: [
          { en: "delicious", ja: "„Åä„ÅÑ„Åó„ÅÑ", level: 1 }, { en: "cook", ja: "ÊñôÁêÜ„Åô„Çã", level: 1 },
          { en: "sweet", ja: "Áîò„ÅÑ", level: 1 }, { en: "eat", ja: "È£ü„Åπ„Çã", level: 1 },
          { en: "fruit", ja: "ÊûúÁâ©", level: 1 }, { en: "restaurant", ja: "„É¨„Çπ„Éà„É©„É≥", level: 1 },
          { en: "healthy", ja: "ÂÅ•Â∫∑ÁöÑ„Å™", level: 2 }, { en: "recipe", ja: "„É¨„Ç∑„Éî", level: 2 },
          { en: "traditional", ja: "‰ºùÁµ±ÁöÑ„Å™", level: 2 }, { en: "taste", ja: "Âë≥", level: 2 },
          { en: "convenience", ja: "‰æøÂà©„Åï", level: 2 }, { en: "vegetable", ja: "ÈáéËèú", level: 2 },
          { en: "ingredient", ja: "ÊùêÊñô", level: 3 }, { en: "nutrition", ja: "Ê†ÑÈ§ä", level: 3 },
          { en: "recommend", ja: "Âãß„ÇÅ„Çã", level: 3 }, { en: "contain", ja: "Âê´„ÇÄ", level: 3 },
          { en: "flavor", ja: "È¢®Âë≥", level: 3 }, { en: "appetite", ja: "È£üÊ¨≤", level: 3 },
          { en: "diet", ja: "È£ü‰∫ãÁôÇÊ≥ï", level: 3 }, { en: "prepare", ja: "Ê∫ñÂÇô„Åô„Çã", level: 3 }
        ]
      },
      { 
        emoji: "‚úàÔ∏è",
        title: "Travel", 
        hint: "Where do you want to go?",
        words: [
          { en: "trip", ja: "ÊóÖË°å", level: 1 }, { en: "country", ja: "ÂõΩ", level: 1 },
          { en: "sea", ja: "Êµ∑", level: 1 }, { en: "hotel", ja: "„Éõ„ÉÜ„É´", level: 1 },
          { en: "bus", ja: "„Éê„Çπ", level: 1 }, { en: "map", ja: "Âú∞Âõ≥", level: 1 },
          { en: "foreign", ja: "Â§ñÂõΩ„ÅÆ", level: 2 }, { en: "experience", ja: "ÁµåÈ®ì", level: 2 },
          { en: "culture", ja: "ÊñáÂåñ", level: 2 }, { en: "tourist", ja: "Ë¶≥ÂÖâÂÆ¢", level: 2 },
          { en: "museum", ja: "ÂçöÁâ©È§®", level: 2 }, { en: "airport", ja: "Á©∫Ê∏Ø", level: 2 },
          { en: "environment", ja: "Áí∞Â¢É", level: 3 }, { en: "scenery", ja: "È¢®ÊôØ", level: 3 },
          { en: "communicate", ja: "ÊÑèÊÄùÁñéÈÄö„Åô„Çã", level: 3 }, { en: "destination", ja: "ÁõÆÁöÑÂú∞", level: 3 },
          { en: "transportation", ja: "‰∫§ÈÄöÊ©üÈñ¢", level: 3 }, { en: "sightseeing", ja: "Ë¶≥ÂÖâ", level: 3 },
          { en: "reservation", ja: "‰∫àÁ¥Ñ", level: 3 }, { en: "explore", ja: "Êé¢Ê§ú„Åô„Çã", level: 3 }
        ]
      },
      { 
        emoji: "üéÆ",
        title: "Hobbies", 
        hint: "What do you do in your free time?",
        words: [
          { en: "like", ja: "Â•Ω„Åç", level: 1 }, { en: "play", ja: "ÈÅä„Å∂", level: 1 },
          { en: "watch", ja: "Ë¶ã„Çã", level: 1 }, { en: "game", ja: "„Ç≤„Éº„É†", level: 1 },
          { en: "read", ja: "Ë™≠„ÇÄ", level: 1 }, { en: "song", ja: "Ê≠å", level: 1 },
          { en: "exciting", ja: "„Çè„Åè„Çè„Åè„Åô„Çã", level: 2 }, { en: "movie", ja: "Êò†Áîª", level: 2 },
          { en: "relax", ja: "„É™„É©„ÉÉ„ÇØ„Çπ„Åô„Çã", level: 2 }, { en: "practice", ja: "Á∑¥Áøí„Åô„Çã", level: 2 },
          { en: "collect", ja: "ÈõÜ„ÇÅ„Çã", level: 2 }, { en: "hobby", ja: "Ë∂£Âë≥", level: 2 },
          { en: "instrument", ja: "Ê•ΩÂô®", level: 3 }, { en: "creative", ja: "ÂâµÈÄ†ÁöÑ„Å™", level: 3 },
          { en: "satisfied", ja: "Ê∫ÄË∂≥„Åó„Åü", level: 3 }, { en: "improve", ja: "Âêë‰∏ä„Åï„Åõ„Çã", level: 3 },
          { en: "performance", ja: "ÊºîÂ•è", level: 3 }, { en: "audience", ja: "Ë¶≥ÂÆ¢", level: 3 },
          { en: "skill", ja: "ÊäÄË°ì", level: 3 }, { en: "participate", ja: "ÂèÇÂä†„Åô„Çã", level: 3 }
        ]
      },
      { 
        emoji: "üîÆ",
        title: "Future", 
        hint: "What do you want to be?",
        words: [
          { en: "job", ja: "‰ªï‰∫ã", level: 1 }, { en: "money", ja: "„ÅäÈáë", level: 1 },
          { en: "dream", ja: "Â§¢", level: 1 }, { en: "big", ja: "Â§ß„Åç„ÅÑ", level: 1 },
          { en: "work", ja: "ÂÉç„Åè", level: 1 }, { en: "rich", ja: "ÈáëÊåÅ„Å°„ÅÆ", level: 1 },
          { en: "decide", ja: "Ê±∫„ÇÅ„Çã", level: 2 }, { en: "abroad", ja: "Êµ∑Â§ñ„Åß", level: 2 },
          { en: "company", ja: "‰ºöÁ§æ", level: 2 }, { en: "useful", ja: "ÂΩπ„Å´Á´ã„Å§", level: 2 },
          { en: "nurse", ja: "ÁúãË≠∑Â∏´", level: 2 }, { en: "earn", ja: "Á®º„Åê", level: 2 },
          { en: "society", ja: "Á§æ‰ºö", level: 3 }, { en: "contribute", ja: "Ë≤¢ÁåÆ„Åô„Çã", level: 3 },
          { en: "specialist", ja: "Â∞ÇÈñÄÂÆ∂", level: 3 }, { en: "realize", ja: "ÂÆüÁèæ„Åô„Çã", level: 3 },
          { en: "university", ja: "Â§ßÂ≠¶", level: 3 }, { en: "career", ja: "ÁµåÊ≠¥", level: 3 },
          { en: "independent", ja: "Áã¨Á´ã„Åó„Åü", level: 3 }, { en: "success", ja: "ÊàêÂäü", level: 3 }
        ]
      },
      { 
        emoji: "‚öΩ",
        title: "Sports", 
        hint: "What sports do you like?",
        words: [
          { en: "run", ja: "Ëµ∞„Çã", level: 1 }, { en: "team", ja: "„ÉÅ„Éº„É†", level: 1 },
          { en: "ball", ja: "„Éú„Éº„É´", level: 1 }, { en: "win", ja: "Âãù„Å§", level: 1 },
          { en: "pool", ja: "„Éó„Éº„É´", level: 1 }, { en: "fan", ja: "„Éï„Ç°„É≥", level: 1 },
          { en: "player", ja: "ÈÅ∏Êâã", level: 2 }, { en: "strong", ja: "Âº∑„ÅÑ", level: 2 },
          { en: "match", ja: "Ë©¶Âêà", level: 2 }, { en: "exercise", ja: "ÈÅãÂãï", level: 2 },
          { en: "lose", ja: "Ë≤†„Åë„Çã", level: 2 }, { en: "rule", ja: "„É´„Éº„É´", level: 2 },
          { en: "opponent", ja: "Áõ∏Êâã", level: 3 }, { en: "compete", ja: "Á´∂‰∫â„Åô„Çã", level: 3 },
          { en: "effort", ja: "Âä™Âäõ", level: 3 }, { en: "professional", ja: "„Éó„É≠„ÅÆ", level: 3 },
          { en: "victory", ja: "ÂãùÂà©", level: 3 }, { en: "stadium", ja: "Á´∂ÊäÄÂ†¥", level: 3 },
          { en: "athlete", ja: "ÈÅãÂãïÈÅ∏Êâã", level: 3 }, { en: "tournament", ja: "„Éà„Éº„Éä„É°„É≥„Éà", level: 3 }
        ]
      },
      { 
        emoji: "üéµ",
        title: "Music", 
        hint: "What kind of music do you listen to?",
        words: [
          { en: "sing", ja: "Ê≠å„ÅÜ", level: 1 }, { en: "listen", ja: "ËÅû„Åè", level: 1 },
          { en: "band", ja: "„Éê„É≥„Éâ", level: 1 }, { en: "cool", ja: "„Åã„Å£„Åì„ÅÑ„ÅÑ", level: 1 },
          { en: "dance", ja: "Ë∏ä„Çã", level: 1 }, { en: "loud", ja: "„ÅÜ„Çã„Åï„ÅÑ", level: 1 },
          { en: "concert", ja: "„Ç≥„É≥„Çµ„Éº„Éà", level: 2 }, { en: "voice", ja: "Â£∞", level: 2 },
          { en: "popular", ja: "‰∫∫Ê∞ó„ÅÆ„ÅÇ„Çã", level: 2 }, { en: "message", ja: "„É°„ÉÉ„Çª„Éº„Ç∏", level: 2 },
          { en: "artist", ja: "Ëä∏Ë°ìÂÆ∂", level: 2 }, { en: "piano", ja: "„Éî„Ç¢„Éé", level: 2 },
          { en: "lyrics", ja: "Ê≠åË©û", level: 3 }, { en: "rhythm", ja: "„É™„Ç∫„É†", level: 3 },
          { en: "influence", ja: "ÂΩ±Èüø", level: 3 }, { en: "perform", ja: "Êºî„Åò„Çã", level: 3 },
          { en: "musician", ja: "Èü≥Ê•ΩÂÆ∂", level: 3 }, { en: "emotional", ja: "ÊÑüÊÉÖÁöÑ„Å™", level: 3 },
          { en: "classic", ja: "ÂÖ∏ÂûãÁöÑ„Å™", level: 3 }, { en: "melody", ja: "ÊóãÂæã", level: 3 }
        ]
      },
      { 
        emoji: "üè†",
        title: "Daily Life", 
        hint: "Tell me about your daily routine.",
        words: [
          { en: "get up", ja: "Ëµ∑„Åç„Çã", level: 1 }, { en: "sleep", ja: "ÂØù„Çã", level: 1 },
          { en: "home", ja: "ÂÆ∂", level: 1 }, { en: "breakfast", ja: "ÊúùÈ£ü", level: 1 },
          { en: "study", ja: "ÂãâÂº∑„Åô„Çã", level: 1 }, { en: "watch TV", ja: "„ÉÜ„É¨„Éì„ÇíË¶ã„Çã", level: 1 },
          { en: "busy", ja: "Âøô„Åó„ÅÑ", level: 2 }, { en: "tired", ja: "Áñ≤„Çå„Åü", level: 2 },
          { en: "weekend", ja: "ÈÄ±Êú´", level: 2 }, { en: "clean", ja: "ÊéÉÈô§„Åô„Çã", level: 2 },
          { en: "early", ja: "Êó©„ÅÑ", level: 2 }, { en: "habit", ja: "ÁøíÊÖ£", level: 2 },
          { en: "regular", ja: "Ë¶èÂâáÁöÑ„Å™", level: 3 }, { en: "schedule", ja: "‰∫àÂÆö", level: 3 },
          { en: "lazy", ja: "ÊÄ†ÊÉ∞„Å™", level: 3 }, { en: "efficient", ja: "ÂäπÁéáÁöÑ„Å™", level: 3 },
          { en: "chore", ja: "ÈõëÁî®", level: 3 }, { en: "commute", ja: "ÈÄöÂ≠¶„Åô„Çã", level: 3 },
          { en: "lifestyle", ja: "ÁîüÊ¥ªÊßòÂºè", level: 3 }, { en: "balance", ja: "„Éê„É©„É≥„Çπ", level: 3 }
        ]
      },
      { 
        emoji: "üë™",
        title: "Family", 
        hint: "Talk about your family or friends.",
        words: [
          { en: "father", ja: "Áà∂", level: 1 }, { en: "mother", ja: "ÊØç", level: 1 },
          { en: "kind", ja: "Ë¶™Âàá„Å™", level: 1 }, { en: "help", ja: "Êâã‰ºù„ÅÜ", level: 1 },
          { en: "live", ja: "‰Ωè„ÇÄ", level: 1 }, { en: "talk", ja: "Ë©±„Åô", level: 1 },
          { en: "brother", ja: "ÂÖÑÂºü", level: 2 }, { en: "sister", ja: "ÂßâÂ¶π", level: 2 },
          { en: "pet", ja: "„Éö„ÉÉ„Éà", level: 2 }, { en: "together", ja: "‰∏ÄÁ∑í„Å´", level: 2 },
          { en: "parent", ja: "Ë¶™", level: 2 }, { en: "birthday", ja: "Ë™ïÁîüÊó•", level: 2 },
          { en: "relation", ja: "Èñ¢‰øÇ", level: 3 }, { en: "support", ja: "ÊîØ„Åà„Çã", level: 3 },
          { en: "advice", ja: "Âä©Ë®Ä", level: 3 }, { en: "memory", ja: "ÊÄù„ÅÑÂá∫", level: 3 },
          { en: "argue", ja: "Âè£Ë´ñ„Åô„Çã", level: 3 }, { en: "respect", ja: "Â∞äÊï¨„Åô„Çã", level: 3 },
          { en: "generation", ja: "‰∏ñ‰ª£", level: 3 }, { en: "resemble", ja: "‰ºº„Å¶„ÅÑ„Çã", level: 3 }
        ]
      },
      { 
        emoji: "üå¶Ô∏è",
        title: "Season", 
        hint: "Which season do you like the best?",
        words: [
          { en: "hot", ja: "Êöë„ÅÑ", level: 1 }, { en: "cold", ja: "ÂØí„ÅÑ", level: 1 },
          { en: "rain", ja: "Èõ®", level: 1 }, { en: "snow", ja: "Èõ™", level: 1 },
          { en: "summer", ja: "Â§è", level: 1 }, { en: "winter", ja: "ÂÜ¨", level: 1 },
          { en: "spring", ja: "Êò•", level: 2 }, { en: "fall", ja: "Áßã", level: 2 },
          { en: "wear", ja: "ÁùÄ„Çã", level: 2 }, { en: "weather", ja: "Â§©Ê∞ó", level: 2 },
          { en: "beautiful", ja: "Áæé„Åó„ÅÑ", level: 2 }, { en: "warm", ja: "Êöñ„Åã„ÅÑ", level: 2 },
          { en: "climate", ja: "Ê∞óÂÄô", level: 3 }, { en: "temperature", ja: "Ê∞óÊ∏©", level: 3 },
          { en: "humid", ja: "ÊπøÊ∞ó„ÅÆÂ§ö„ÅÑ", level: 3 }, { en: "activity", ja: "Ê¥ªÂãï", level: 3 },
          { en: "festival", ja: "Á•≠„Çä", level: 3 }, { en: "comfortable", ja: "Âø´ÈÅ©„Å™", level: 3 },
          { en: "seasonal", ja: "Â≠£ÁØÄ„ÅÆ", level: 3 }, { en: "forecast", ja: "‰∫àÂ†±", level: 3 }
        ]
      }
    ];

    // ‰ø°È†ºÊÄß„ÅÆÈ´ò„ÅÑBGM URL
    const BGM_SOURCES = [
      "https://cdn.pixabay.com/download/audio/2022/11/22/audio_febc508520.mp3", // Happy Upbeat
      "https://cdn.pixabay.com/download/audio/2022/10/25/audio_5103407886.mp3", // Fun Comedy
    ];

    // „Éù„Ç§„É≥„ÉàÂÆöÁæ©
    const POINTS = {
      1: 10,
      2: 20,
      3: 30
    };

    function App() {
      // --- State Management ---
      const [mode, setMode] = useState('menu'); // 'menu' | 'game'
      
      // Game Data
      const [currentTopic, setCurrentTopic] = useState(TOPICS_DATA[0]);
      const [activeCards, setActiveCards] = useState([]);
      
      // Game Status
      const [timeLeft, setTimeLeft] = useState(60);
      const [gameTime, setGameTime] = useState(60);
      const [isActive, setIsActive] = useState(false);
      
      // Scoring: Player A vs Player B
      const [scoreA, setScoreA] = useState(0);
      const [scoreB, setScoreB] = useState(0);
      
      // Card Ownership: { index: 'A' | 'B' | null }
      const [cardStatus, setCardStatus] = useState({});

      // Audio
      const [isMuted, setIsMuted] = useState(false);
      const audioRef = useRef(null);

      const timerRef = useRef(null);

      // --- Logic ---

      // „Éà„Éî„ÉÉ„ÇØ„Å®„Ç´„Éº„Éâ„Çí„É©„É≥„ÉÄ„É†„Å´Ë®≠ÂÆöÔºà„Çπ„Ç≥„Ç¢„ÉªÊôÇÈñì„ÅØ„Ç™„Éó„Ç∑„Éß„É≥„Åß„É™„Çª„ÉÉ„ÉàÔºâ
      const setupRound = (resetStats = false) => {
        // „É©„É≥„ÉÄ„É†„Éà„Éî„ÉÉ„ÇØ
        const randomTopic = TOPICS_DATA[Math.floor(Math.random() * TOPICS_DATA.length)];
        setCurrentTopic(randomTopic);

        // „Ç´„Éº„ÉâÈÅ∏Âá∫„É≠„Ç∏„ÉÉ„ÇØ: ÂêÑ„É¨„Éô„É´„Åã„Çâ„Éê„É©„É≥„Çπ„Çà„ÅèÈÅ∏Âá∫
        const l1 = (randomTopic.words || []).filter(w => w.level === 1).sort(() => 0.5 - Math.random()).slice(0, 2);
        const l2 = (randomTopic.words || []).filter(w => w.level === 2).sort(() => 0.5 - Math.random()).slice(0, 2);
        const l3 = (randomTopic.words || []).filter(w => w.level === 3).sort(() => 0.5 - Math.random()).slice(0, 2);
        
        // Ê∑∑„Åú„Çã
        const mixed = [...l1, ...l2, ...l3].sort(() => 0.5 - Math.random());
        setActiveCards(mixed);

        // „Ç´„Éº„ÉâÁä∂ÊÖã„É™„Çª„ÉÉ„ÉàÔºàÊñ∞„Åó„ÅÑ„Ç´„Éº„Éâ„Å´„Å™„Çã„Åü„ÇÅÔºâ
        setCardStatus({});

        if (resetStats) {
          setScoreA(0);
          setScoreB(0);
          setTimeLeft(gameTime);
          setIsActive(false);
          // Èü≥Ê•ΩÂÅúÊ≠¢
          if (audioRef.current) {
            audioRef.current.pause();
            audioRef.current.currentTime = 0;
          }
        }
      };

      // ÂÆåÂÖ®„Å´Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†„ÇíÈñãÂßãÔºà„É™„Çª„ÉÉ„Éà„ÅÇ„ÇäÔºâ
      const initNewGame = () => {
        setupRound(true);
        setMode('game');
      };

      // Ê¨°„ÅÆ„Éà„Éî„ÉÉ„ÇØ„Å∏ÈÄ≤„ÇÄÔºà„Çπ„Ç≥„Ç¢„ÉªÊôÇÈñìÁ∂≠ÊåÅÔºâ
      const nextTopic = () => {
        setupRound(false);
      };

      const startGame = () => {
        setIsActive(true);
        
        // BGMÂÜçÁîü
        if (!isMuted && audioRef.current) {
          const randomSrc = BGM_SOURCES[Math.floor(Math.random() * BGM_SOURCES.length)];
          audioRef.current.src = randomSrc;
          audioRef.current.volume = 0.3; 
          
          const playPromise = audioRef.current.play();
          if (playPromise !== undefined) {
            playPromise.catch(error => {
              console.log("Audio playback was prevented or interrupted:", error);
            });
          }
        }
      };

      // „Çø„Ç§„Éû„Éº
      useEffect(() => {
        if (isActive && timeLeft > 0) {
          timerRef.current = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
        } else if (timeLeft === 0) {
          setIsActive(false);
          if (audioRef.current) {
            audioRef.current.pause();
            audioRef.current.currentTime = 0;
          }
        }
        return () => {
          if (timerRef.current) clearTimeout(timerRef.current);
        };
      }, [isActive, timeLeft]);

      // ÂÖ®„Å¶„ÅÆ„Ç´„Éº„Éâ„ÅåÂèñ„Çâ„Çå„Åü„ÅãÁõ£Ë¶ñ„Åô„Çã
      useEffect(() => {
        if (isActive && activeCards.length > 0) {
          const takenCount = Object.keys(cardStatus).length;
          if (takenCount === activeCards.length) {
            // ÂÖ®„Å¶Âèñ„Çâ„Çå„Åü„ÇâÂ∞ë„ÅóÂæÖ„Å£„Å¶Ê¨°„ÅÆ„Éà„Éî„ÉÉ„ÇØ„Å∏
            const timeout = setTimeout(() => {
              nextTopic();
            }, 800);
            return () => clearTimeout(timeout);
          }
        }
      }, [cardStatus, isActive, activeCards]);

      // „Ç´„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
      const handleCardClick = (index, player) => {
        if (!isActive && timeLeft > 0) return; // „Ç≤„Éº„É†‰∏≠„ÅÆ„Åø
        if (cardStatus[index]) return; // ÂèñÂæóÊ∏à„Åø„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ

        // ÂèñÂæóÁä∂ÊÖãÊõ¥Êñ∞
        setCardStatus(prev => ({ ...prev, [index]: player }));

        // ÁÇπÊï∞Âä†ÁÆó
        const card = activeCards[index];
        if (card) {
          const points = POINTS[card.level];
          if (player === 'A') setScoreA(s => s + points);
          else setScoreB(s => s + points);
        }
      };

      // --- Components ---

      const WinnerOverlay = () => {
        if (timeLeft > 0) return null;
        
        let resultTitle = "";
        let resultColor = "";
        if (scoreA > scoreB) {
          resultTitle = "WINNER: PLAYER A";
          resultColor = "text-blue-600";
        } else if (scoreB > scoreA) {
          resultTitle = "WINNER: PLAYER B";
          resultColor = "text-pink-600";
        } else {
          resultTitle = "DRAW!";
          resultColor = "text-purple-600";
        }

        return (
          <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center animate-in fade-in duration-500 backdrop-blur-sm">
            <div className="bg-white p-8 md:p-12 rounded-3xl shadow-2xl text-center transform animate-in zoom-in duration-300 max-w-2xl w-full mx-4 border-4 border-yellow-400">
              <Crown size={80} className={`mx-auto mb-4 ${resultColor} animate-bounce`} />
              <h2 className={`text-4xl md:text-5xl font-black ${resultColor} mb-6`}>{resultTitle}</h2>
              
              <div className="flex justify-center gap-8 md:gap-16 mb-8">
                <div className="bg-blue-50 p-4 rounded-xl w-32">
                  <div className="text-sm font-bold text-blue-400">Player A</div>
                  <div className="text-4xl font-black text-blue-600">{scoreA}</div>
                </div>
                <div className="bg-pink-50 p-4 rounded-xl w-32">
                  <div className="text-sm font-bold text-pink-400">Player B</div>
                  <div className="text-4xl font-black text-pink-600">{scoreB}</div>
                </div>
              </div>

              <button 
                onClick={initNewGame} 
                className="w-full py-4 bg-slate-800 text-white rounded-xl font-bold text-xl hover:bg-slate-700 hover:scale-[1.02] transition-all shadow-lg flex items-center justify-center gap-2"
              >
                <RefreshCw /> Play Again
              </button>
            </div>
          </div>
        );
      };

      const GameScreen = () => {
        const progress = (timeLeft / gameTime) * 100;

        return (
          <div className="flex flex-col h-screen bg-slate-100 text-slate-800 overflow-hidden font-sans">
            
            {/* Top Bar */}
            <div className="bg-white shadow-sm border-b px-4 py-2 flex justify-between items-center shrink-0 h-16">
              <button onClick={() => setMode('menu')} className="text-slate-400 font-bold text-xs hover:text-slate-600 px-2 py-1 rounded border border-transparent hover:border-slate-200">
                EXIT
              </button>
              
              {/* Score Display */}
              <div className="flex items-center gap-4 md:gap-12 flex-1 justify-center">
                {/* Player A */}
                <div className={`flex flex-col items-center transition-transform ${scoreA > scoreB ? 'scale-110' : 'scale-100'}`}>
                  <span className="text-[10px] font-black text-blue-500 tracking-widest">PLAYER A</span>
                  <span className="text-3xl font-black text-blue-600 leading-none">{scoreA}</span>
                </div>
                
                {/* Timer */}
                <div className={`flex flex-col items-center w-20 ${timeLeft < 10 ? 'text-red-500 animate-pulse' : 'text-slate-700'}`}>
                  <Clock size={18} className="mb-0.5 opacity-50" />
                  <span className="text-2xl font-mono font-bold leading-none">{timeLeft}</span>
                </div>

                {/* Player B */}
                <div className={`flex flex-col items-center transition-transform ${scoreB > scoreA ? 'scale-110' : 'scale-100'}`}>
                  <span className="text-[10px] font-black text-pink-500 tracking-widest">PLAYER B</span>
                  <span className="text-3xl font-black text-pink-600 leading-none">{scoreB}</span>
                </div>
              </div>

              <button onClick={() => setIsMuted(!isMuted)} className="text-slate-400 hover:text-slate-600 p-2">
                {isMuted ? <VolumeX size={20} /> : <Volume2 size={20} />}
              </button>
            </div>

            {/* Progress Bar */}
            <div className="w-full bg-slate-200 h-2 shrink-0">
              <div 
                className={`h-full transition-all duration-1000 linear ${timeLeft < 10 ? 'bg-red-500' : 'bg-gradient-to-r from-blue-400 to-pink-400'}`} 
                style={{ width: `${progress}%` }}
              ></div>
            </div>

            {/* Main Game Area */}
            <div className="flex-1 flex flex-col p-2 md:p-4 gap-4 overflow-hidden max-w-6xl mx-auto w-full">
              
              {/* Topic Header (Click to Skip Topic without Reset) */}
              <div 
                onClick={nextTopic}
                className="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 flex flex-col items-center justify-center text-center shrink-0 relative cursor-pointer hover:shadow-md transition-all group"
              >
                <div className="absolute top-3 right-3 text-slate-300 group-hover:text-indigo-500 transition-colors">
                  <RefreshCw size={18}/>
                </div>
                <div className="flex items-center gap-3 mb-1">
                  <span className="text-4xl">{currentTopic.emoji}</span>
                  <h2 className="text-xl md:text-2xl font-black text-slate-800 uppercase tracking-tight">{currentTopic.title}</h2>
                </div>
                <p className="text-slate-500 font-medium text-sm md:text-lg">"{currentTopic.hint}"</p>
              </div>

              {/* Cards Grid */}
              <div className="flex-1 relative">
                {/* Start Button Overlay */}
                {!isActive && timeLeft === gameTime && (
                  <div className="absolute inset-0 z-20 flex items-center justify-center bg-white/50 backdrop-blur-[2px] rounded-xl">
                     <button 
                       onClick={startGame} 
                       className="group relative bg-slate-900 text-white px-10 py-6 rounded-full font-black text-3xl shadow-2xl hover:scale-105 transition-transform flex items-center gap-4 overflow-hidden"
                     >
                       <div className="absolute inset-0 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                       <span className="relative flex items-center gap-3 z-10"><Play fill="currentColor" /> START</span>
                     </button>
                  </div>
                )}

                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 h-full content-start">
                  {activeCards.map((card, idx) => {
                    const status = cardStatus[idx]; // 'A' or 'B' or null
                    const isUsed = !!status;
                    const points = POINTS[card.level];
                    
                    // Ëâ≤ÂàÜ„Åë
                    let borderClass = "";
                    let bgClass = "";
                    let badgeColor = "";
                    let levelLabel = "";

                    if (card.level === 1) {
                      borderClass = "border-blue-200";
                      bgClass = "bg-blue-50/30";
                      badgeColor = "bg-blue-500";
                      levelLabel = "L1 (+10)";
                    } else if (card.level === 2) {
                      borderClass = "border-emerald-200";
                      bgClass = "bg-emerald-50/30";
                      badgeColor = "bg-emerald-500";
                      levelLabel = "L2 (+20)";
                    } else {
                      borderClass = "border-yellow-200";
                      bgClass = "bg-yellow-50/30";
                      badgeColor = "bg-yellow-500";
                      levelLabel = "L3 (+30)";
                    }

                    return (
                      <div 
                        key={idx}
                        className={`
                          relative rounded-xl border-2 shadow-sm overflow-hidden flex flex-col justify-between transition-all select-none
                          aspect-[3/4] md:aspect-auto md:h-full
                          ${borderClass} ${bgClass}
                          ${isUsed ? 'opacity-50 grayscale scale-95' : 'hover:-translate-y-1 hover:shadow-md'}
                        `}
                      >
                        {/* Level Badge */}
                        <div className="flex justify-between items-center px-2 py-1.5 border-b border-black/5 bg-white/50">
                          <span className={`text-[10px] font-bold text-white px-2 py-0.5 rounded-full ${badgeColor}`}>
                            {levelLabel}
                          </span>
                        </div>

                        {/* Content */}
                        <div className="flex-1 flex flex-col items-center justify-center p-2 text-center">
                          <div className="font-bold text-lg leading-tight mb-1 text-slate-800">{card.en}</div>
                          <div className="text-xs text-slate-500">{card.ja}</div>
                        </div>

                        {/* Click Areas (Invisible until hover/touch) */}
                        {!isUsed ? (
                          <div className="absolute inset-0 z-10 flex opacity-0 hover:opacity-100 active:opacity-100 transition-opacity cursor-pointer">
                            {/* Player A Area */}
                            <div 
                              className="w-1/2 h-full bg-blue-500/10 flex items-center justify-center border-r border-slate-300/30 active:bg-blue-500/30 transition-colors"
                              onClick={() => handleCardClick(idx, 'A')}
                            >
                              <span className="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded shadow-sm transform -translate-x-2">A</span>
                            </div>
                            {/* Player B Area */}
                            <div 
                              className="w-1/2 h-full bg-pink-500/10 flex items-center justify-center active:bg-pink-500/30 transition-colors"
                              onClick={() => handleCardClick(idx, 'B')}
                            >
                               <span className="bg-pink-600 text-white text-xs font-bold px-2 py-1 rounded shadow-sm transform translate-x-2">B</span>
                            </div>
                          </div>
                        ) : (
                          // Taken Overlay
                          <div className="absolute inset-0 flex items-center justify-center bg-slate-100/80 z-20 backdrop-blur-[1px]">
                             <div className={`text-4xl font-black ${status === 'A' ? 'text-blue-500' : 'text-pink-500'}`}>
                               {status}
                             </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
            
            <WinnerOverlay />
          </div>
        );
      };

      const MenuScreen = () => (
        <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50 p-6 font-sans text-slate-800">
          <div className="bg-white p-10 rounded-3xl shadow-xl w-full max-w-md text-center border border-slate-200">
            <div className="mb-6 flex justify-center">
              <div className="bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-4 rounded-2xl shadow-lg">
                <Trophy size={48} />
              </div>
            </div>
            <h1 className="text-4xl font-black mb-2 text-slate-900 tracking-tight">
              PAIR SPEAKING<br/>CHALLENGE
            </h1>
            <p className="text-slate-500 mb-8 font-medium">Earn points by using English!</p>

            <div className="space-y-4 mb-8 text-left bg-slate-50 p-4 rounded-xl border border-slate-100">
              <h3 className="font-bold text-slate-700 flex items-center gap-2">
                <Star size={16} className="text-yellow-500" fill="currentColor"/> Points System
              </h3>
              <ul className="text-sm space-y-2 text-slate-600">
                <li className="flex justify-between items-center">
                  <span><span className="bg-blue-500 text-white px-1.5 rounded-full text-[10px] mr-2 font-bold">L1</span>Basic Words</span>
                  <span className="font-bold text-blue-600">+10 pt</span>
                </li>
                <li className="flex justify-between items-center">
                  <span><span className="bg-emerald-500 text-white px-1.5 rounded-full text-[10px] mr-2 font-bold">L2</span>Grade 3</span>
                  <span className="font-bold text-emerald-600">+20 pt</span>
                </li>
                <li className="flex justify-between items-center">
                  <span><span className="bg-yellow-500 text-white px-1.5 rounded-full text-[10px] mr-2 font-bold">L3</span>Grade Pre-2</span>
                  <span className="font-bold text-yellow-600">+30 pt</span>
                </li>
              </ul>
            </div>

            <button
              onClick={initNewGame}
              className="w-full bg-slate-900 text-white py-5 rounded-2xl text-xl font-bold shadow-xl hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-3"
            >
              <Play fill="currentColor" /> START GAME
            </button>
          </div>
        </div>
      );

      return (
        <React.Fragment>
          <audio ref={audioRef} loop />
          {mode === 'menu' && <MenuScreen />}
          {mode === 'game' && <GameScreen />}
        </React.Fragment>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
